<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>投資收益管家</title>
    
    <!-- 1. 樣式庫 (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. 核心函式庫 -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- PropTypes (Recharts 依賴) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <!-- Recharts -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        /* 隱藏捲軸 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden">

    <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-slate-500 font-bold">正在啟動...</p>
    </div>

    <div id="root" class="flex-1 flex flex-col h-full overflow-hidden"></div>

    <script type="text/babel">
        (function() {
            try {
                const { useState, useEffect, useMemo, useRef } = React;
                const R = window.Recharts || {};
                const { AreaChart, Area, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, PieChart, Pie, Cell } = R;

                // --- 1. 圖示系統 ---
                const ICON_PATHS = {
                    TrendingUp: ["M23 6L13.5 15.5L8.5 10.5L1 18", "M17 6H23V12"], 
                    Trash2: ["M3 6H21", "M19 6V20C19 21.1 18.1 22 17 22H7C5.9 22 5 21.1 5 20V6", "M8 6V4C8 2.9 8.9 2 10 2H14C15.1 2 16 2.9 16 4V6", "M10 11V17", "M14 11V17"],
                    Save: ["M19 21H5C3.9 21 3 20.1 3 19V5C3 3.9 3.9 3 5 3H16L21 8V19C21 20.1 20.1 21 19 21Z", "M17 21V13H7V21", "M7 3V8H15"],
                    BarChart2: ["M18 20V10", "M12 20V4", "M6 20V14"],
                    Sparkles: ["M12 3L10.088 8.736L4.352 10.648L10.088 12.56L12 18.296L13.912 12.56L19.648 10.648L13.912 8.736L12 3Z"],
                    Loader2: ["M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3"],
                    Database: ["M12 5C16.97 5 21 3.66 21 2C21 0.34 16.97 -1 12 -1C7.03 -1 3 0.34 3 2C3 3.66 7.03 5 12 5Z", "M21 12C21 13.66 16.97 15 12 15C7.03 15 3 13.66 3 12", "M3 5V19C3 20.66 7.03 22 12 22C16.97 22 21 20.66 21 19V5"],
                    Check: ["M20 6L9 17L4 12"],
                    X: ["M18 6L6 18", "M6 6L18 18"],
                    Download: ["M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15", "M7 10L12 15L17 10", "M12 15V3"],
                    Upload: ["M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15", "M17 8L12 3L7 8", "M12 3V15"],
                    AlertTriangle: ["M10.29 3.86L1.82 18C1.64537 18.3024 1.55296 18.6453 1.55199 18.9945C1.55103 19.3437 1.64155 19.6871 1.81442 19.9905C1.98729 20.2939 2.23659 20.5467 2.5377 20.7239C2.8388 20.9011 3.18126 20.9967 3.53 21H20.47C20.8187 20.9967 21.1612 20.9011 21.4623 20.7239C21.7634 20.5467 22.0127 20.2939 22.1856 19.9905C22.3584 19.6871 22.449 19.3437 22.448 18.9945C22.447 18.6453 22.3546 18.3024 22.18 18L13.71 3.86C13.5317 3.56611 13.2807 3.32312 12.9812 3.15449C12.6817 2.98587 12.3437 2.89728 12 2.89728C11.6563 2.89728 11.3183 2.98587 11.0188 3.15449C10.7193 3.32312 10.4683 3.56611 10.29 3.86V3.86Z", "M12 9V13", "M12 17H12.01"],
                    Smartphone: ["M5 2H19C20.1 2 21 2.9 21 4V20C21 21.1 20.1 22 19 22H5C3.9 22 3 21.1 3 20V4C3 2.9 3.9 2 5 2Z", "M12 18H12.01"],
                    Maximize: ["M8 3H5C4.46957 3 3.96086 3.21071 3.58579 3.58579C3.21071 3.96086 3 4.46957 3 5V8", "M16 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V8", "M21 16V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H16", "M8 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V16"],
                    Minimize: ["M8 3V6H3", "M21 8H18V3", "M21 16H18V21", "M3 16H6V21"],
                    Eye: ["M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z", "M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"],
                    EyeOff: ["M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94", "M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 012.16 3.19", "M1 1L23 23"],
                    PieChart: ["M21.21 15.89A10 10 0 118 2.83", "M22 12A10 10 0 0012 2V12H22Z"]
                };

                const Icon = ({ d, size = 24, className = "" }) => (
                    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                        {Array.isArray(d) ? d.map((p, i) => <path key={i} d={p} />) : <path d={d} />}
                    </svg>
                );

                const Icons = {};
                Object.keys(ICON_PATHS).forEach(key => {
                    Icons[key] = (props) => <Icon d={ICON_PATHS[key]} {...props} />;
                });
                const { TrendingUp, Trash2, Save, BarChart2, Sparkles, Loader2, Database, Check, X, Download, Upload, AlertTriangle, Smartphone, Maximize, Minimize, Eye, EyeOff, PieChart: PieIcon } = Icons;

                // --- 2. 共用元件 ---
                const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>;
                
                const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, size = "md" }) => {
                    const baseStyle = "rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transform select-none";
                    const sizes = { sm: "px-3 py-1.5 text-sm", md: "px-4 py-3" };
                    const variants = {
                        primary: "bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800",
                        secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 active:bg-slate-300",
                        danger: "bg-red-50 text-red-600 hover:bg-red-100 active:bg-red-200",
                        outline: "border border-slate-300 text-slate-600 hover:bg-slate-50",
                        magic: "bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-md hover:opacity-90",
                        warning: "bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200",
                        ghost: "text-slate-500 hover:bg-slate-100 hover:text-slate-900",
                    };
                    return <button onClick={onClick} className={`${baseStyle} ${sizes[size]} ${variants[variant]} ${className}`} disabled={disabled}>{children}</button>;
                };

                const Input = ({ label, value, onChange, type = "text", placeholder = "" }) => (
                    <div className="flex flex-col gap-1 w-full">{label && <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>}<input type={type} value={value} onChange={onChange} placeholder={placeholder} className="border border-slate-300 rounded-lg px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-base bg-white appearance-none" /></div>
                );

                const Select = ({ label, value, onChange, options }) => (
                    <div className="flex flex-col gap-1 w-full">{label && <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>}<div className="relative"><select value={value} onChange={onChange} className="border border-slate-300 rounded-lg px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-base bg-white appearance-none">{options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><svg className="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></div></div></div>
                );

                // --- 3. App 主邏輯 ---
                const App = () => {
                    const safeLoad = (key, def) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; } catch { return def; } };
                    const [settings, setSettings] = useState(() => safeLoad('inv_settings', { benchmarkName: '台股加權指數', apiKey: '', lastBackupDate: null }));
                    const [accounts, setAccounts] = useState(() => safeLoad('inv_accounts', [{ id: 'a1', name: '帳號 A', color: '#3b82f6' }, { id: 'a2', name: '帳號 B', color: '#10b981' }, { id: 'a3', name: '帳號 C', color: '#f59e0b' }]));
                    const [records, setRecords] = useState(() => safeLoad('inv_records', []));

                    const [activeTab, setActiveTab] = useState('dashboard');
                    const [chartMode, setChartMode] = useState('value');
                    const [timeRange, setTimeRange] = useState('ALL');
                    const [isFullscreen, setIsFullscreen] = useState(false);
                    const [notification, setNotification] = useState(null);
                    const [modalType, setModalType] = useState(null);
                    const [showBackupAlert, setShowBackupAlert] = useState(false);
                    const [isPrivacyMode, setIsPrivacyMode] = useState(false);
                    
                    // Input States
                    const [entryDate, setEntryDate] = useState(new Date().toISOString().split('T')[0]);
                    const [selectedAccount, setSelectedAccount] = useState(accounts.length>0 ? accounts[0].id : '');
                    const [marketValue, setMarketValue] = useState('');
                    const [inputFlow, setInputFlow] = useState(''); // 新增：用於資金流向輸入的金額
                    const [flowType, setFlowType] = useState('none');
                    const [benchmarkInput, setBenchmarkInput] = useState('');
                    
                    // AI & Import States
                    const [isAiProcessing, setIsAiProcessing] = useState(false);
                    const [pasteContent, setPasteContent] = useState('');
                    const [aiError, setAiError] = useState(null);
                    const [importFile, setImportFile] = useState(null);

                    const PIE_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'];

                    // Effects
                    useEffect(() => { try{localStorage.setItem('inv_accounts', JSON.stringify(accounts));}catch{} }, [accounts]);
                    useEffect(() => { try{localStorage.setItem('inv_records', JSON.stringify(records));}catch{} }, [records]);
                    useEffect(() => { try{localStorage.setItem('inv_settings', JSON.stringify(settings));}catch{} }, [settings]);
                    useEffect(() => { if(accounts.length>0 && !accounts.find(a=>a.id===selectedAccount)) setSelectedAccount(accounts[0].id); }, [accounts, selectedAccount]);
                    useEffect(() => { const h=()=>setIsFullscreen(!!document.fullscreenElement); document.addEventListener("fullscreenchange",h); return ()=>document.removeEventListener("fullscreenchange",h); }, []);
                    useEffect(() => { if(records.length===0)return; const last=settings.lastBackupDate?new Date(settings.lastBackupDate):null; if(!last||(new Date()-last>30*86400000)) setShowBackupAlert(true); else setShowBackupAlert(false); }, [settings.lastBackupDate, records.length]);
                    useEffect(() => { document.getElementById('loader').style.display='none'; }, []);

                    // Helpers
                    const showToast = (m) => { setNotification(m); setTimeout(()=>setNotification(null), 3000); };
                    const toggleFs = () => { if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else if(document.exitFullscreen) document.exitFullscreen().catch(()=>{}); };
                    const fmtCur = (v) => isPrivacyMode ? '****' : new Intl.NumberFormat('zh-TW',{maximumFractionDigits:0}).format(v);
                    const fmtPct = (v) => `${v>0?'+':''}${v?.toFixed(2)}%`;

                    // Logic
                    const sortedRecs = useMemo(()=>[...records].sort((a,b)=>new Date(a.date)-new Date(b.date)), [records]);
                    
                    // 自動填入上一次的大盤指數
                    useEffect(()=>{ 
                        if(sortedRecs.length>0 && !benchmarkInput) {
                            const lastBench = sortedRecs[sortedRecs.length-1].benchmarkValue;
                            if(lastBench) setBenchmarkInput(lastBench); 
                        }
                    },[sortedRecs]);

                    const accStats = useMemo(()=>{
                        const res={}; accounts.forEach(a=>res[a.id]={name:a.name,color:a.color,currentValue:0,totalInvested:0,roi:0});
                        accounts.forEach(a=>{
                            const rs=sortedRecs.filter(r=>r.accountId===a.id);
                            if(rs.length===0) return;
                            const f=rs[0];
                            const init=parseFloat(f.marketValue)-parseFloat(f.cashFlow);
                            const flows=rs.reduce((s,r)=>s+parseFloat(r.cashFlow),0);
                            const inv=init+flows;
                            const cur=parseFloat(rs[rs.length-1].marketValue);
                            res[a.id]={...res[a.id], currentValue:cur, totalInvested:inv, roi:inv?((cur-inv)/inv)*100:0};
                        });
                        return res;
                    },[accounts,sortedRecs]);

                    const totalStats = useMemo(()=>{
                        let v=0,i=0; Object.values(accStats).forEach(s=>{v+=s.currentValue;i+=s.totalInvested;});
                        return {value:v, invested:i, pl:v-i, roi:i?((v-i)/i)*100:0};
                    },[accStats]);

                    const pieData = useMemo(()=>Object.values(accStats).filter(s=>s.currentValue>0).map((s,i)=>({name:s.name,value:s.currentValue,color:s.color||PIE_COLORS[i%PIE_COLORS.length]})),[accStats]);

                    const chartData = useMemo(()=>{
                        if(sortedRecs.length===0) return [];
                        const dates=[...new Set(sortedRecs.map(r=>r.date))].sort();
                        const res=[];
                        let initBench = parseFloat(sortedRecs.find(r=>r.benchmarkValue)?.benchmarkValue||0);
                        
                        dates.forEach(d=>{
                            let tv=0, ti=0;
                            accounts.forEach(a=>{
                                const rs=sortedRecs.filter(r=>r.accountId===a.id && r.date<=d);
                                if(rs.length>0) {
                                    const l=rs[rs.length-1];
                                    tv+=parseFloat(l.marketValue);
                                    ti+=(parseFloat(rs[0].marketValue)-parseFloat(rs[0].cashFlow)) + rs.reduce((s,r)=>s+parseFloat(r.cashFlow),0);
                                }
                            });
                            const pt = {date:d, total:tv, userROI:ti?((tv-ti)/ti)*100:0};
                            const bRec = sortedRecs.filter(r=>r.date<=d && r.benchmarkValue).pop();
                            if(bRec) {
                                const b=parseFloat(bRec.benchmarkValue);
                                pt.benchmarkVal=b;
                                if(initBench) pt.benchmarkROI=((b-initBench)/initBench)*100;
                            }
                            res.push(pt);
                        });
                        return res;
                    },[sortedRecs,accounts]);

                    const filteredData = useMemo(()=>{
                        if(chartData.length===0 || timeRange==='ALL') return chartData;
                        const last=new Date(chartData[chartData.length-1].date);
                        const cut=new Date(last);
                        if(timeRange==='1D') cut.setDate(last.getDate()-2);
                        else if(timeRange==='1W') cut.setDate(last.getDate()-7);
                        else if(timeRange==='1Y') cut.setFullYear(last.getFullYear()-1);
                        else if(timeRange==='3Y') cut.setFullYear(last.getFullYear()-3);
                        else if(timeRange==='5Y') cut.setFullYear(last.getFullYear()-5);
                        return chartData.filter(d=>new Date(d.date)>=cut);
                    },[chartData,timeRange]);

                    const handleAdd = () => {
                        if(!marketValue||!entryDate||!selectedAccount) return showToast("請填寫日期、帳號與市值");
                        const cf = parseFloat(inputFlow)||0;
                        const finalCf = flowType==='deposit'?Math.abs(cf) : flowType==='withdraw'?-Math.abs(cf) : 0;
                        const nr = {id:Date.now(), date:entryDate, accountId:selectedAccount, marketValue:parseFloat(marketValue), cashFlow:finalCf, benchmarkValue:benchmarkInput};
                        setRecords(p=>{
                            const ex = p.findIndex(r=>r.date===entryDate && r.accountId===selectedAccount);
                            if(ex>=0) { const n=[...p]; n[ex]=nr; return n; }
                            return [...p, nr];
                        });
                        setMarketValue(''); setInputFlow(''); setFlowType('none'); 
                        showToast("已儲存");
                    };

                    const exportJSON = () => {
                        const d={accounts,records,settings:{...settings,lastBackupDate:new Date().toISOString()}};
                        const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d)); a.download=`backup_${d.settings.lastBackupDate.split('T')[0]}.json`;
                        a.click(); setSettings(d.settings); setShowBackupAlert(false); showToast("備份已下載");
                    };

                    const handleImportExecute = () => {
                        if (!importFile) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const d = JSON.parse(e.target.result);
                                if(d.accounts) setAccounts(d.accounts);
                                if(d.records) setRecords(d.records);
                                if(d.settings) setSettings(d.settings);
                                setModalType(null);
                                showToast("資料已還原");
                            } catch (err) {
                                showToast("檔案格式錯誤");
                            }
                        };
                        reader.readAsText(importFile);
                    };

                    const handleAI = async () => {
                        if(!settings.apiKey) return setAiError("請輸入 API Key");
                        setIsAiProcessing(true);
                        try {
                            const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${settings.apiKey}`,{
                                method:"POST",headers:{"Content-Type":"application/json"},
                                body:JSON.stringify({contents:[{parts:[{text:`Analyze investment data from text: "${pasteContent}". Return pure JSON object (no markdown): {"marketValue": number, "benchmarkValue": number|null}. Remove commas from numbers.`}]}]})
                            });
                            if(!res.ok) throw new Error();
                            const d=await res.json();
                            let text = d.candidates[0].content.parts[0].text;
                            text = text.replace(/```json/g,'').replace(/```/g,'').trim();
                            const j=JSON.parse(text);
                            if(j.marketValue) { setMarketValue(j.marketValue); if(j.benchmarkValue) setBenchmarkInput(j.benchmarkValue); setModalType(null); showToast("解析成功"); }
                        } catch (e) { console.error(e); setAiError("解析失敗: " + e.message); } finally { setIsAiProcessing(false); }
                    };

                    const Modal = ({ title, onClose, children }) => (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}><div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-fade-in" onClick={e=>e.stopPropagation()}><div className="p-5 border-b border-slate-100 flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">{title}</h3><button onClick={onClose} className="text-slate-400"><X size={24}/></button></div><div className="p-6">{children}</div></div></div>
                    );

                    return (
                        <div className="max-w-lg mx-auto w-full h-full relative flex flex-col bg-slate-50">
                            {notification && <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg z-50 text-sm flex items-center gap-2 animate-fade-in"><Check size={16} className="text-green-400"/>{notification}</div>}
                            
                            {/* Modals */}
                            {modalType === 'clear' && <Modal title="清空資料" onClose={()=>setModalType(null)}><p className="text-center mb-4 text-red-600 font-bold">此動作無法復原！</p><div className="flex gap-3"><Button onClick={()=>setModalType(null)} variant="secondary" className="flex-1">取消</Button><Button onClick={()=>{setRecords([]);setAccounts([{id:'a1',name:'帳號 A',color:'#3b82f6'}]);setModalType(null);showToast("已重置")}} variant="danger" className="flex-1">清空</Button></div></Modal>}
                            {modalType === 'install' && <Modal title="安裝教學" onClose={()=>setModalType(null)}><div className="space-y-3 text-sm text-slate-600"><p><strong>iOS:</strong> Safari 分享按鈕 &gt; 加入主畫面</p><p><strong>Android:</strong> Chrome 選單 &gt; 加入主畫面</p><Button onClick={()=>setModalType(null)} className="w-full mt-2">好</Button></div></Modal>}
                            {modalType === 'import' && <Modal title="還原備份" onClose={()=>{setModalType(null);setImportFile(null)}}><p className="text-center mb-4 text-slate-600">確定要從 {importFile?.name} 還原資料嗎？現有資料將被覆蓋。</p><div className="flex gap-3"><Button onClick={()=>{setModalType(null);setImportFile(null)}} variant="secondary" className="flex-1">取消</Button><Button onClick={handleImportExecute} variant="primary" className="flex-1">還原</Button></div></Modal>}
                            {modalType === 'ai' && <Modal title="AI 貼上" onClose={()=>setModalType(null)}><textarea className="w-full h-32 border p-2 rounded mb-2 text-sm" value={pasteContent} onChange={e=>setPasteContent(e.target.value)} placeholder="貼上對帳單文字..." /><div className="flex justify-end gap-2"><Button onClick={()=>setModalType(null)} variant="secondary">取消</Button><Button onClick={handleAI} variant="magic" disabled={isAiProcessing}>{isAiProcessing?<Loader2 className="animate-spin"/>:'解析'}</Button></div>{aiError && <p className="text-red-500 text-sm mt-2">{aiError}</p>}</Modal>}

                            {/* Header */}
                            <header className="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 py-3 safe-top flex flex-col gap-3 shadow-sm flex-shrink-0">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2"><span className="bg-blue-600 text-white p-1 rounded"><TrendingUp size={18}/></span><h1 className="font-bold text-slate-800 text-lg">投資收益管家</h1></div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setIsPrivacyMode(!isPrivacyMode)} className="text-slate-400 p-2 rounded-full hover:bg-slate-100">{isPrivacyMode?<EyeOff size={20}/>:<Eye size={20}/>}</button>
                                        <button onClick={toggleFs} className="text-slate-400 p-2 rounded-full hover:bg-slate-100 md:hidden">{isFullscreen?<Minimize size={20}/>:<Maximize size={20}/>}</button>
                                    </div>
                                </div>
                                <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1">
                                    {[{id:'dashboard',l:'儀表板'},{id:'input',l:'記帳'},{id:'records',l:'歷史'},{id:'settings',l:'設定'}].map(t=><button key={t.id} onClick={()=>setActiveTab(t.id)} className={`px-4 py-1.5 rounded-full whitespace-nowrap text-sm font-medium transition ${activeTab===t.id?'bg-slate-800 text-white shadow':'text-slate-500 hover:bg-slate-100'}`}>{t.l}</button>)}
                                </div>
                            </header>

                            {/* Main Content */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-safe-bottom">
                                {activeTab === 'dashboard' && (
                                    <div className="space-y-4 animate-fade-in pb-20">
                                        {showBackupAlert && <div className="bg-amber-50 border border-amber-200 p-3 rounded-lg flex justify-between items-center text-sm text-amber-800"><span className="flex items-center gap-2"><AlertTriangle size={16}/> 建議備份</span><Button onClick={exportJSON} size="sm" variant="warning">備份</Button></div>}
                                        <div className="grid grid-cols-2 gap-4">
                                            <Card className="p-4 border-l-4 border-blue-500"><div className="text-xs text-slate-500">總市值</div><div className="text-xl font-bold text-slate-800">{fmtCur(totalStats.value)}</div></Card>
                                            <Card className={`p-4 border-l-4 ${totalStats.roi>=0?'border-red-500':'border-green-500'}`}><div className="text-xs text-slate-500">總報酬</div><div className={`text-xl font-bold ${totalStats.roi>=0?'text-red-600':'text-green-600'}`}>{fmtPct(totalStats.roi)}</div></Card>
                                        </div>
                                        <Card className="p-4 h-72">
                                            <div className="flex justify-between items-center mb-4"><div className="font-bold text-slate-700 flex items-center gap-2"><BarChart2 size={16}/> 走勢</div><div className="flex bg-slate-100 rounded p-1"><button onClick={()=>setChartMode('value')} className={`px-2 py-1 text-xs rounded ${chartMode==='value'?'bg-white shadow':''}`}>值</button><button onClick={()=>setChartMode('roi')} className={`px-2 py-1 text-xs rounded ${chartMode==='roi'?'bg-white shadow':''}`}>%</button></div></div>
                                            <div className="flex gap-1 mb-2 overflow-x-auto scrollbar-hide">{['1M','1Y','3Y','ALL'].map(r=><button key={r} onClick={()=>setTimeRange(r)} className={`px-2 py-1 text-xs rounded border ${timeRange===r?'bg-slate-800 text-white border-slate-800':'border-slate-200 text-slate-500'}`}>{r}</button>)}</div>
                                            <ResponsiveContainer width="100%" height="80%">
                                                {chartMode === 'value' ? 
                                                    <ComposedChart data={filteredData}><defs><linearGradient id="cV" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.1}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient></defs><XAxis dataKey="date" hide/><YAxis domain={['auto','auto']} hide/><Tooltip formatter={v=>fmtCur(v)}/><Area type="monotone" dataKey="total" stroke="#3b82f6" fill="url(#cV)" strokeWidth={2}/><Line type="monotone" dataKey="benchmarkVal" stroke="#f97316" strokeDasharray="3 3" dot={false}/></ComposedChart> :
                                                    <LineChart data={filteredData}><XAxis dataKey="date" hide/><YAxis hide/><Tooltip formatter={v=>fmtPct(v)}/><Line type="monotone" dataKey="userROI" stroke="#ef4444" dot={false} strokeWidth={2}/><Line type="monotone" dataKey="benchmarkROI" stroke="#94a3b8" dot={false}/></LineChart>
                                                }
                                            </ResponsiveContainer>
                                        </Card>
                                        <Card className="p-4">
                                            <div className="font-bold text-slate-700 mb-4 flex items-center gap-2"><PieIcon size={16}/> 配置</div>
                                            <div className="h-40"><ResponsiveContainer><PieChart><Pie data={pieData} innerRadius={35} outerRadius={60} dataKey="value"><Tooltip formatter={v=>fmtCur(v)}/>{pieData.map((e,i)=><Cell key={i} fill={e.color}/>)}</Pie></PieChart></ResponsiveContainer></div>
                                            <div className="space-y-2 text-sm">{pieData.map(d=><div key={d.name} className="flex justify-between"><div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full" style={{backgroundColor:d.color}}></span>{d.name}</div><span>{((d.value/totalStats.value)*100).toFixed(1)}%</span></div>)}</div>
                                        </Card>
                                    </div>
                                )}

                                {activeTab === 'input' && (
                                    <Card className="p-5 space-y-5 animate-fade-in pb-20">
                                        <div className="flex justify-between items-center"><h2 className="font-bold text-slate-800">新增紀錄</h2><Button variant="magic" size="sm" onClick={()=>setModalType('ai')}><Sparkles size={16}/> AI 貼上</Button></div>
                                        
                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-3">
                                                <Input type="date" label="日期" value={entryDate} onChange={e=>setEntryDate(e.target.value)} />
                                                <Select label="帳戶" value={selectedAccount} onChange={e=>setSelectedAccount(e.target.value)} options={accounts.map(a=>({value:a.id,label:a.name}))} />
                                            </div>
                                            
                                            <Input label="當前總市值" type="number" value={marketValue} onChange={e=>setMarketValue(e.target.value)} placeholder="輸入金額" />
                                            
                                            <div className="pt-2">
                                                <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 block">資金變動</label>
                                                <div className="flex gap-2 mb-2">
                                                    <button onClick={()=>{setFlowType('none');setInputFlow('')}} className={`flex-1 py-2 text-sm rounded border transition ${flowType==='none'?'bg-slate-800 text-white border-slate-800':'bg-white text-slate-600 border-slate-200'}`}>無</button>
                                                    <button onClick={()=>setFlowType('deposit')} className={`flex-1 py-2 text-sm rounded border transition ${flowType==='deposit'?'bg-blue-600 text-white border-blue-600':'bg-white text-slate-600 border-slate-200'}`}>存入</button>
                                                    <button onClick={()=>setFlowType('withdraw')} className={`flex-1 py-2 text-sm rounded border transition ${flowType==='withdraw'?'bg-orange-500 text-white border-orange-500':'bg-white text-slate-600 border-slate-200'}`}>領出</button>
                                                </div>
                                                {flowType!=='none' && <div className="animate-fade-in"><Input type="number" placeholder="輸入變動金額" value={inputFlow} onChange={e=>setInputFlow(e.target.value)}/></div>}
                                            </div>

                                            <div className="pt-2 border-t border-slate-100">
                                                 <Input label="大盤指數 (選填)" type="number" value={benchmarkInput} onChange={e=>setBenchmarkInput(e.target.value)} placeholder="例如: 20000" />
                                                 <p className="text-xs text-slate-400 mt-1">用於計算相對績效 (Alpha)</p>
                                            </div>
                                        </div>

                                        <Button onClick={handleAdd} className="w-full mt-4 text-lg py-4 shadow-md shadow-blue-200"><Save size={20}/> 儲存紀錄</Button>
                                    </Card>
                                )}

                                {activeTab === 'records' && (
                                    <div className="space-y-3 animate-fade-in pb-20">
                                        {sortedRecs.slice().reverse().map(r=>(
                                            <div key={r.id} className="bg-white p-3 rounded-lg border border-slate-100 flex justify-between items-center shadow-sm">
                                                <div>
                                                    <div className="text-sm font-bold text-slate-700 flex items-center gap-2">{r.date} <span className="text-[10px] font-normal text-slate-400 border px-1 rounded">{accounts.find(a=>a.id===r.accountId)?.name}</span></div>
                                                    <div className="text-xs text-slate-400 mt-1 flex gap-2">
                                                        {r.cashFlow!==0 && <span className={r.cashFlow>0?'text-blue-500 font-medium':'text-orange-500 font-medium'}>{r.cashFlow>0?'存入':'領出'} {Math.abs(r.cashFlow)}</span>}
                                                        {r.benchmarkValue && <span className="text-slate-300">| 指數 {r.benchmarkValue}</span>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <div className="font-mono font-medium text-slate-800">{fmtCur(r.marketValue)}</div>
                                                    <button onClick={()=>setRecords(p=>p.filter(x=>x.id!==r.id))} className="text-slate-300 hover:text-red-500 p-2"><Trash2 size={18}/></button>
                                                </div>
                                            </div>
                                        ))}
                                        {records.length===0 && <div className="text-center text-slate-400 py-10">尚無紀錄</div>}
                                    </div>
                                )}

                                {activeTab === 'settings' && (
                                    <div className="space-y-4 animate-fade-in pb-20">
                                        <Card className="p-4 flex justify-between items-center"><div className="flex gap-3 items-center"><Smartphone className="text-blue-600"/><div><div className="font-bold">App 模式</div><div className="text-xs text-slate-500">安裝到主畫面</div></div></div><Button size="sm" variant="outline" onClick={()=>setModalType('install')}>查看</Button></Card>
                                        
                                        <Card className="p-4 space-y-3">
                                            <h3 className="font-bold flex gap-2 items-center text-slate-700"><Database size={18}/> 資料管理</h3>
                                            <div className="flex gap-2">
                                                <Button onClick={exportJSON} variant="outline" className="flex-1 text-sm"><Download size={16}/> 備份 JSON</Button>
                                                <div className="flex-1 relative">
                                                    <input type="file" accept=".json" onChange={e=>{if(e.target.files?.length){setImportFile(e.target.files[0]);setModalType('import');e.target.value='';}}} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                                                    <Button variant="outline" className="w-full text-sm"><Upload size={16}/> 還原 JSON</Button>
                                                </div>
                                            </div>
                                            <div className="pt-2 border-t border-slate-100 flex justify-end">
                                                <Button onClick={()=>setModalType('clear')} variant="danger" size="sm" className="px-3 text-xs">清空全部資料</Button>
                                            </div>
                                        </Card>

                                        <Card className="p-4">
                                            <h3 className="font-bold mb-2 text-slate-700">AI 設定 (Gemini API)</h3>
                                            <Input type="password" value={settings.apiKey} onChange={e=>setSettings({...settings,apiKey:e.target.value})} placeholder="貼上 API Key" />
                                            <p className="text-[10px] text-slate-400 mt-1">Key 僅儲存於本地瀏覽器，不會上傳伺服器。</p>
                                        </Card>

                                        <Card className="p-4 space-y-2">
                                            <h3 className="font-bold text-slate-700 mb-2">帳戶管理</h3>
                                            {accounts.map(a=>(
                                                <div key={a.id} className="flex gap-2 items-center">
                                                    <input type="color" value={a.color} onChange={e=>{const n=[...accounts];n.find(x=>x.id===a.id).color=e.target.value;setAccounts(n)}} className="w-8 h-8 rounded border-none cursor-pointer flex-shrink-0"/>
                                                    <Input value={a.name} onChange={e=>{const n=[...accounts];n.find(x=>x.id===a.id).name=e.target.value;setAccounts(n)}} />
                                                    <button onClick={()=>{if(accounts.length>1){if(confirm('確定刪除此帳號與相關紀錄?')){setAccounts(accounts.filter(x=>x.id!==a.id));setRecords(records.filter(r=>r.accountId!==a.id))}}}} className="text-slate-300 hover:text-red-500 p-2"><Trash2 size={18}/></button>
                                                </div>
                                            ))}
                                            <Button onClick={()=>{setAccounts([...accounts, {id:Date.now().toString(), name:'新帳號', color:'#64748b'}])}} variant="secondary" className="w-full mt-2 text-sm">新增帳號</Button>
                                        </Card>
                                        
                                        <div className="text-center text-xs text-slate-300 pt-4">v1.1.1 Offline Storage</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                };

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            } catch (err) {
                document.getElementById('loader').innerHTML = '<div class="p-4 text-center text-red-500"><p class="font-bold">系統錯誤</p><p class="text-sm">'+err.message+'</p></div>';
                console.error(err);
            }
        })();
    </script>
</body>
</html>
