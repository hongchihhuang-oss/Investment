<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>投資收益管家</title>
    
    <!-- 1. 樣式庫 (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. 核心函式庫 (順序很重要) -->
    <!-- React Core -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- PropTypes (Recharts 依賴項，必須在 Recharts 之前載入) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- Recharts (圖表庫) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    
    <!-- 3. Babel 解析器 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        /* 隱藏捲軸但保留功能 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <!-- 啟動畫面 / 錯誤提示 -->
    <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p id="loader-text" class="text-slate-500 font-bold">正在啟動系統...</p>
        <p id="error-text" class="text-red-500 text-sm mt-2 hidden text-center px-4"></p>
        <button id="retry-btn" onclick="window.location.reload()" class="hidden mt-4 px-4 py-2 bg-slate-100 rounded text-slate-600">重試</button>
    </div>

    <!-- React 根目錄 -->
    <div id="root"></div>

    <!-- 系統檢查腳本 -->
    <script>
        // 檢查必要函式庫是否載入
        window.onload = function() {
            setTimeout(function() {
                const missing = [];
                if (!window.React) missing.push("React");
                if (!window.ReactDOM) missing.push("ReactDOM");
                // Recharts 載入失敗通常是因為 PropTypes，如果前面報錯，這裡也會抓到
                if (!window.Recharts) missing.push("Recharts");
                
                if (missing.length > 0) {
                    document.getElementById('loader').querySelector('.animate-spin').style.display = 'none';
                    document.getElementById('loader-text').innerText = "啟動失敗";
                    document.getElementById('error-text').innerText = "無法載入必要元件 (" + missing.join(", ") + ")。\n請檢查網路連線後重試。";
                    document.getElementById('error-text').style.display = 'block';
                    document.getElementById('retry-btn').style.display = 'block';
                }
            }, 3000); // 3秒後檢查
        };
    </script>

    <!-- 主程式邏輯 -->
    <script type="text/babel">
        // 使用 IIFE 避免全域變數污染
        (function() {
            try {
                const { useState, useEffect, useMemo, useRef } = React;
                // 安全解構 Recharts，避免未載入時報錯
                const R = window.Recharts || {};
                // 提供預設元件以防 Recharts 載入失敗
                const AreaChart = R.AreaChart || (() => null);
                const Area = R.Area || (() => null);
                const LineChart = R.LineChart || (() => null);
                const Line = R.Line || (() => null);
                const XAxis = R.XAxis || (() => null);
                const YAxis = R.YAxis || (() => null);
                const CartesianGrid = R.CartesianGrid || (() => null);
                const Tooltip = R.Tooltip || (() => null);
                const Legend = R.Legend || (() => null);
                const ResponsiveContainer = R.ResponsiveContainer || (({children}) => <div>{children}</div>);
                const ComposedChart = R.ComposedChart || (() => null);
                const PieChart = R.PieChart || (() => null);
                const Pie = R.Pie || (() => null);
                const Cell = R.Cell || (() => null);

                // --- Icons (使用 SVG 路徑，不依賴外部 icon font) ---
                const Icon = ({ d, size = 24, className = "", ...props }) => (
                    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                        {Array.isArray(d) ? d.map((p, i) => <path key={i} d={p} />) : <path d={d} />}
                    </svg>
                );
                
                // 簡易圖示定義
                const ICONS = {
                    TrendingUp: <polyline points="23 6 13.5 15.5 8.5 10.5 1 18 17 6 23 6 23 12" />, 
                    Menu: "M3 12h18M3 6h18M3 18h18",
                    Plus: "M12 5v14M5 12h14",
                    Trash: "M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2",
                    Save: "M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z",
                    Settings: "M12 15a3 3 0 100-6 3 3 0 000 6z M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z",
                    Chart: "M18 20V10M12 20V4M6 20v-6",
                    Pie: "M21.21 15.89A10 10 0 118 2.83M22 12A10 10 0 0012 2v10z",
                    Download: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3",
                    Upload: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12",
                    Eye: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 9a3 3 0 100 6 3 3 0 000-6z",
                    EyeOff: "M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24 M1 1l22 22",
                    Sparkles: "M12 3l-1.9 5.8a2 2 0 01-1.3 1.3L3 12l5.8 1.9a2 2 0 011.3 1.3L12 21l1.9-5.8a2 2 0 011.3-1.3L21 12l-5.8-1.9a2 2 0 01-1.3-1.3L12 3z"
                };

                // --- UI Components ---
                const Card = ({ children, className = "" }) => (
                    <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>
                        {children}
                    </div>
                );

                const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, size = "md" }) => {
                    const baseStyle = "rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transform select-none";
                    const sizes = { sm: "px-3 py-1.5 text-sm", md: "px-4 py-3" };
                    const variants = {
                        primary: "bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800",
                        secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 active:bg-slate-300",
                        danger: "bg-red-50 text-red-600 hover:bg-red-100 active:bg-red-200",
                        outline: "border border-slate-300 text-slate-600 hover:bg-slate-50",
                        magic: "bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-md hover:opacity-90",
                        warning: "bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200",
                        ghost: "text-slate-500 hover:bg-slate-100 hover:text-slate-900",
                    };
                    return (
                        <button onClick={onClick} className={`${baseStyle} ${sizes[size]} ${variants[variant]} ${className}`} disabled={disabled}>
                            {children}
                        </button>
                    );
                };

                const Input = ({ label, value, onChange, type = "text", placeholder = "", className="" }) => (
                    <div className={`flex flex-col gap-1 w-full ${className}`}>
                        {label && <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>}
                        <input
                            type={type}
                            value={value}
                            onChange={onChange}
                            placeholder={placeholder}
                            className="border border-slate-300 rounded-lg px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full text-base bg-white appearance-none"
                        />
                    </div>
                );

                const Select = ({ label, value, onChange, options }) => (
                    <div className="flex flex-col gap-1 w-full">
                        {label && <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>}
                        <div className="relative">
                            <select
                                value={value}
                                onChange={onChange}
                                className="border border-slate-300 rounded-lg px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-base bg-white appearance-none"
                            >
                                {options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                            </select>
                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <svg className="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>
                );

                // --- App Component ---
                const App = () => {
                    // ... (Code logic remains the same, ensuring Card is used after definition) ...
                    // Safe Loading
                    const safeLoad = (key, def) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; } catch { return def; } };
                    const [settings, setSettings] = useState(() => safeLoad('inv_settings', { benchmarkName: '台股加權指數', apiKey: '', lastBackupDate: null }));
                    const [accounts, setAccounts] = useState(() => safeLoad('inv_accounts', [{ id: 'acc1', name: '帳號 A', color: '#3b82f6' }, { id: 'acc2', name: '帳號 B', color: '#10b981' }, { id: 'acc3', name: '帳號 C', color: '#f59e0b' }]));
                    const [records, setRecords] = useState(() => safeLoad('inv_records', []));

                    const [activeTab, setActiveTab] = useState('dashboard');
                    const [chartMode, setChartMode] = useState('value');
                    const [timeRange, setTimeRange] = useState('ALL');
                    const [isFullscreen, setIsFullscreen] = useState(false);
                    const [notification, setNotification] = useState(null);
                    const [modalType, setModalType] = useState(null);
                    const [showBackupAlert, setShowBackupAlert] = useState(false);
                    const [isPrivacyMode, setIsPrivacyMode] = useState(false);
                    
                    const [entryDate, setEntryDate] = useState(new Date().toISOString().split('T')[0]);
                    const [selectedAccount, setSelectedAccount] = useState(accounts.length > 0 ? accounts[0].id : '');
                    const [marketValue, setMarketValue] = useState('');
                    const [cashFlow, setCashFlow] = useState('0');
                    const [flowType, setFlowType] = useState('none');
                    const [benchmarkInput, setBenchmarkInput] = useState('');
                    
                    const [isAiProcessing, setIsAiProcessing] = useState(false);
                    const [pasteContent, setPasteContent] = useState('');
                    const [aiError, setAiError] = useState(null);
                    const [importFile, setImportFile] = useState(null);
                    const fileInputRef = useRef(null);

                    const PIE_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'];

                    // Effects
                    useEffect(() => { try { localStorage.setItem('inv_accounts', JSON.stringify(accounts)); } catch{} }, [accounts]);
                    useEffect(() => { try { localStorage.setItem('inv_records', JSON.stringify(records)); } catch{} }, [records]);
                    useEffect(() => { try { localStorage.setItem('inv_settings', JSON.stringify(settings)); } catch{} }, [settings]);
                    useEffect(() => { if (accounts.length > 0 && !accounts.find(a => a.id === selectedAccount)) setSelectedAccount(accounts[0].id); }, [accounts, selectedAccount]);
                    
                    useEffect(() => {
                        const handleFs = () => setIsFullscreen(!!document.fullscreenElement);
                        document.addEventListener("fullscreenchange", handleFs);
                        return () => document.removeEventListener("fullscreenchange", handleFs);
                    }, []);

                    useEffect(() => {
                        if (records.length === 0) return;
                        const last = settings.lastBackupDate ? new Date(settings.lastBackupDate) : null;
                        if (!last || (new Date() - last > 30 * 86400000)) setShowBackupAlert(true);
                        else setShowBackupAlert(false);
                    }, [settings.lastBackupDate, records.length]);

                    useEffect(() => { document.getElementById('loader').style.display = 'none'; }, []);

                    // Utils
                    const showToast = (msg) => { setNotification(msg); setTimeout(() => setNotification(null), 3000); };
                    const toggleFullscreen = () => { if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else if (document.exitFullscreen) document.exitFullscreen().catch(()=>{}); };
                    const formatCurrency = (val) => isPrivacyMode ? '****' : new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
                    const formatPercent = (val) => `${val > 0 ? '+' : ''}${val?.toFixed(2)}%`;

                    // Logic & Render
                    const sortedRecords = useMemo(() => [...records].sort((a, b) => new Date(a.date) - new Date(b.date)), [records]);
                    
                    useEffect(() => {
                        if (sortedRecords.length > 0 && !benchmarkInput) {
                            const last = sortedRecords[sortedRecords.length-1];
                            if (last.benchmarkValue) setBenchmarkInput(last.benchmarkValue);
                        }
                    }, [sortedRecords]);

                    const accountStats = useMemo(() => {
                        const stats = {};
                        accounts.forEach(acc => stats[acc.id] = { name: acc.name, color: acc.color, currentValue: 0, totalInvested: 0, profitLoss: 0, roi: 0 });
                        accounts.forEach(acc => {
                            const recs = sortedRecords.filter(r => r.accountId === acc.id);
                            if (recs.length === 0) return;
                            const first = recs[0];
                            const init = parseFloat(first.marketValue) - parseFloat(first.cashFlow);
                            const flows = recs.reduce((sum, r) => sum + parseFloat(r.cashFlow), 0);
                            const last = recs[recs.length - 1];
                            const netInvested = init + flows;
                            const current = parseFloat(last.marketValue);
                            stats[acc.id] = { name: acc.name, color: acc.color, currentValue: current, totalInvested: netInvested, profitLoss: current - netInvested, roi: netInvested !== 0 ? ((current - netInvested) / netInvested) * 100 : 0 };
                        });
                        return stats;
                    }, [accounts, sortedRecords]);

                    const totalStats = useMemo(() => {
                        let v = 0, i = 0;
                        Object.values(accountStats).forEach(s => { v += s.currentValue; i += s.totalInvested; });
                        return { value: v, invested: i, pl: v - i, roi: i !== 0 ? ((v - i) / i) * 100 : 0 };
                    }, [accountStats]);

                    const pieData = useMemo(() => Object.values(accountStats).filter(s => s.currentValue > 0).map((s, idx) => ({ name: s.name, value: s.currentValue, color: s.color || PIE_COLORS[idx % PIE_COLORS.length] })), [accountStats]);

                    const chartData = useMemo(() => {
                        if (sortedRecords.length === 0) return [];
                        const dates = [...new Set(sortedRecords.map(r => r.date))].sort();
                        const result = [];
                        let initBench = parseFloat(sortedRecords.find(r=>r.benchmarkValue)?.benchmarkValue || 0);
                        const getAccState = (id, d) => {
                            const rel = sortedRecords.filter(r => r.accountId === id && r.date <= d);
                            if (rel.length === 0) return null;
                            const l = rel[rel.length - 1];
                            const f = rel[0];
                            const inv = (parseFloat(f.marketValue) - parseFloat(f.cashFlow)) + rel.reduce((s,r) => s + parseFloat(r.cashFlow), 0);
                            return { val: parseFloat(l.marketValue), inv };
                        };
                        dates.forEach(d => {
                            const pt = { date: d };
                            let tv = 0, ti = 0;
                            accounts.forEach(acc => { const s = getAccState(acc.id, d); if (s) { pt[acc.id] = s.val; tv += s.val; ti += s.inv; } });
                            pt.total = tv; pt.userROI = ti !== 0 ? ((tv - ti) / ti) * 100 : 0;
                            const bRec = sortedRecords.filter(r => r.date <= d && r.benchmarkValue).pop();
                            if (bRec) { const curB = parseFloat(bRec.benchmarkValue); pt.benchmarkVal = curB; if (initBench) pt.benchmarkROI = ((curB - initBench) / initBench) * 100; }
                            result.push(pt);
                        });
                        return result;
                    }, [sortedRecords, accounts]);

                    const filteredData = useMemo(() => {
                        if (chartData.length === 0 || timeRange === 'ALL') return chartData;
                        const last = new Date(chartData[chartData.length - 1].date);
                        const cut = new Date(last);
                        if (timeRange === '1D') cut.setDate(last.getDate() - 2);
                        else if (timeRange === '1W') cut.setDate(last.getDate() - 7);
                        else if (timeRange === '1Y') cut.setFullYear(last.getFullYear() - 1);
                        else if (timeRange === '3Y') cut.setFullYear(last.getFullYear() - 3);
                        else if (timeRange === '5Y') cut.setFullYear(last.getFullYear() - 5);
                        return chartData.filter(d => new Date(d.date) >= cut);
                    }, [chartData, timeRange]);

                    // Actions
                    const addRec = () => {
                        if (!marketValue || !entryDate || !selectedAccount) { showToast("請填寫完整"); return; }
                        const flow = parseFloat(cashFlow) || 0;
                        const finalFlow = flowType === 'deposit' ? Math.abs(flow) : flowType === 'withdraw' ? -Math.abs(flow) : 0;
                        const newRec = { id: Date.now().toString(), date: entryDate, accountId: selectedAccount, marketValue: parseFloat(marketValue), cashFlow: finalFlow, benchmarkValue: benchmarkInput };
                        const idx = records.findIndex(r => r.date === entryDate && r.accountId === selectedAccount);
                        if (idx >= 0) { const n = [...records]; n[idx] = newRec; setRecords(n); showToast("已更新"); } else { setRecords([...records, newRec]); showToast("已儲存"); }
                        setMarketValue(''); setCashFlow('0'); setFlowType('none');
                    };
                    const delRec = (id) => { setRecords(records.filter(r => r.id !== id)); showToast("已刪除"); };
                    const exportJSON = () => {
                        const d = { accounts, records, settings: { ...settings, lastBackupDate: new Date().toISOString() } };
                        const url = URL.createObjectURL(new Blob([JSON.stringify(d)], { type: "application/json" }));
                        const link = document.createElement("a"); link.href = url; link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
                        link.click(); setSettings(d.settings); setShowBackupAlert(false); showToast("備份已下載");
                    };
                    const importJSON = () => {
                        if (!importFile) return;
                        const reader = new FileReader();
                        reader.onload = (e) => { try { const d = JSON.parse(e.target.result); if(d.accounts) { setAccounts(d.accounts); setRecords(d.records || []); if(d.settings) setSettings(d.settings); showToast("還原成功"); setModalType(null); } } catch { showToast("檔案錯誤"); } };
                        reader.readAsText(importFile);
                    };
                    const exportCSV = () => {
                        const h = ["日期","帳號","市值","資金","大盤"];
                        const r = records.map(x=>[x.date, accounts.find(a=>a.id===x.accountId)?.name, x.marketValue, x.cashFlow, x.benchmarkValue||''].join(","));
                        const u = URL.createObjectURL(new Blob(["\uFEFF"+[h.join(","),...r].join("\n")], { type: "text/csv;charset=utf-8;" }));
                        const l = document.createElement("a"); l.href = u; l.download = "data.csv"; l.click(); showToast("CSV 下載");
                    };
                    const genDemo = () => {
                        const accs = [{ id: 'a1', name: 'A帳號', color: '#3b82f6' }, { id: 'a2', name: 'B帳號', color: '#10b981' }, { id: 'a3', name: 'C帳號', color: '#f59e0b' }];
                        setAccounts(accs);
                        const recs = [];
                        let v1 = 800000, v2 = 300000, v3 = 1000000, bench = 9000;
                        let d = new Date(); d.setDate(d.getDate() - 3650);
                        for (let i = 0; i < 3650; i++) {
                            const ds = d.toISOString().split('T')[0];
                            v1 *= (1 + (Math.random() * 0.035 - 0.017)); v2 *= (1 + (Math.random() * 0.02 - 0.0095)); v3 *= (1 + (Math.random() * 0.003 - 0.0013)); bench *= (1 + (Math.random() * 0.025 - 0.012));
                            let f1=0, f2=0, f3=0;
                            if(i>0 && i%365===0) { f1=120000; v1+=f1; f2=60000; v2+=f2; }
                            if(i>0 && i%1095===150) { f3=-400000; v3+=f3; }
                            recs.push({id:`d1_${i}`, date:ds, accountId:'a1', marketValue:Math.round(v1), cashFlow:i===0?0:f1, benchmarkValue:Math.round(bench)});
                            recs.push({id:`d2_${i}`, date:ds, accountId:'a2', marketValue:Math.round(v2), cashFlow:i===0?0:f2, benchmarkValue:Math.round(bench)});
                            recs.push({id:`d3_${i}`, date:ds, accountId:'a3', marketValue:Math.round(v3), cashFlow:i===0?0:f3, benchmarkValue:Math.round(bench)});
                            d.setDate(d.getDate()+1);
                        }
                        setRecords(recs); setModalType(null); showToast("已生成數據"); setActiveTab('dashboard');
                    };
                    const handleClear = () => { setRecords([]); setAccounts([{ id: 'a1', name: '帳號 A', color: '#3b82f6' }]); setModalType(null); showToast("已重置"); };
                    const handleAI = async () => {
                        if(!settings.apiKey) { setAiError("請輸入 Key"); return; }
                        setIsAiProcessing(true);
                        try {
                            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${settings.apiKey}`, {
                                method: "POST", headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ contents: [{ parts: [{ text: `Analyze: "${pasteContent}". Return JSON: {"marketValue": number, "benchmarkValue": number|null}. Remove commas.` }] }] })
                            });
                            if(!res.ok) throw new Error();
                            const d = await res.json();
                            const j = JSON.parse(d.candidates[0].content.parts[0].text.replace(/```json/g,'').replace(/```/g,'').trim());
                            if(j.marketValue) { setMarketValue(j.marketValue); if(j.benchmarkValue) setBenchmarkInput(j.benchmarkValue); setModalType(null); showToast("解析成功"); }
                        } catch { setAiError("失敗"); } finally { setIsAiProcessing(false); }
                    };

                    const Modal = ({ title, children, onClose }) => (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}><div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-fade-in" onClick={e=>e.stopPropagation()}><div className="p-5 border-b border-slate-100 flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">{title}</h3><button onClick={onClose} className="text-slate-400"><X size={24}/></button></div><div className="p-6">{children}</div></div></div>
                    );

                    return (
                        <div className="pb-24 max-w-lg mx-auto relative">
                            {notification && <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg z-50 text-sm flex items-center gap-2"><Check size={16} className="text-green-400"/>{notification}</div>}
                            
                            {modalType === 'demo' && <Modal title="生成模擬資料" onClose={()=>setModalType(null)}><p className="text-center mb-4 text-slate-600">將覆蓋現有資料。</p><div className="flex gap-3"><Button onClick={()=>setModalType(null)} variant="secondary" className="flex-1">取消</Button><Button onClick={genDemo} variant="warning" className="flex-1">生成</Button></div></Modal>}
                            {modalType === 'clear' && <Modal title="清空資料" onClose={()=>setModalType(null)}><p className="text-center mb-4 text-red-600 font-bold">此動作無法復原！</p><div className="flex gap-3"><Button onClick={()=>setModalType(null)} variant="secondary" className="flex-1">取消</Button><Button onClick={handleClear} variant="danger" className="flex-1">清空</Button></div></Modal>}
                            {modalType === 'import' && <Modal title="還原備份" onClose={()=>{setModalType(null);setImportFile(null)}}><p className="text-center mb-4 text-slate-600">將覆蓋目前資料。</p><div className="flex gap-3"><Button onClick={()=>{setModalType(null);setImportFile(null)}} variant="secondary" className="flex-1">取消</Button><Button onClick={importJSON} variant="primary" className="flex-1">確定</Button></div></Modal>}
                            {modalType === 'ai' && <Modal title="AI 貼上" onClose={()=>setModalType(null)}><textarea className="w-full h-32 border p-2 rounded mb-2" placeholder="貼上文字..." value={pasteContent} onChange={e=>setPasteContent(e.target.value)}/><div className="flex justify-end gap-2"><Button onClick={()=>setModalType(null)} variant="secondary">取消</Button><Button onClick={handleAI} variant="magic" disabled={isAiProcessing}>{isAiProcessing?<Loader2 className="animate-spin"/>:'解析'}</Button></div>{aiError && <p className="text-red-500 text-sm mt-2">{aiError}</p>}</Modal>}
                            {modalType === 'install' && <Modal title="安裝教學" onClose={()=>setModalType(null)}><div className="space-y-3 text-sm text-slate-600"><p><strong>iOS (Safari):</strong> 分享 &gt; 加入主畫面</p><p><strong>Android (Chrome):</strong> 選單 &gt; 加入主畫面</p><Button onClick={()=>setModalType(null)} className="w-full mt-2">好</Button></div></Modal>}

                            <header className="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 py-3 safe-top flex flex-col gap-3">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2"><span className="bg-blue-600 text-white p-1 rounded"><Icon d={ICONS.TrendingUp} size={18}/></span><h1 className="font-bold text-slate-800 text-lg">投資收益管家</h1></div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setIsPrivacyMode(!isPrivacyMode)} className="text-slate-400 p-2 rounded-full hover:bg-slate-100"><Icon d={isPrivacyMode?ICONS.EyeOff:ICONS.Eye}/></button>
                                        <button onClick={toggleFullscreen} className="text-slate-400 p-2 rounded-full hover:bg-slate-100 md:hidden"><Icon d={isFullscreen?ICONS.Minimize:ICONS.Maximize}/></button>
                                    </div>
                                </div>
                                <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1">
                                    {[{id:'dashboard',l:'儀表板'},{id:'input',l:'記帳'},{id:'records',l:'歷史'},{id:'settings',l:'設定'}].map(t=><button key={t.id} onClick={()=>setActiveTab(t.id)} className={`px-4 py-1.5 rounded-full whitespace-nowrap text-sm font-medium transition ${activeTab===t.id?'bg-slate-800 text-white shadow':'text-slate-500 hover:bg-slate-100'}`}>{t.l}</button>)}
                                </div>
                            </header>

                            <div className="p-4 space-y-6">
                                {activeTab === 'dashboard' && (
                                    <div className="space-y-4 animate-fade-in">
                                        {showBackupAlert && <div className="bg-amber-50 border border-amber-200 p-3 rounded-lg flex justify-between items-center text-sm text-amber-800"><span className="flex items-center gap-2"><AlertTriangle size={16}/> 建議備份</span><Button onClick={exportJSON} size="sm" variant="warning">備份</Button></div>}
                                        <div className="grid grid-cols-2 gap-4">
                                            <Card className="p-4 border-l-4 border-blue-500"><div className="text-xs text-slate-500">總市值</div><div className="text-xl font-bold text-slate-800">{formatCurrency(totalStats.value)}</div></Card>
                                            <Card className={`p-4 border-l-4 ${totalStats.roi>=0?'border-red-500':'border-green-500'}`}><div className="text-xs text-slate-500">總報酬</div><div className={`text-xl font-bold ${totalStats.roi>=0?'text-red-600':'text-green-600'}`}>{formatPercent(totalStats.roi)}</div></Card>
                                        </div>
                                        <Card className="p-4 h-72">
                                            <div className="flex justify-between items-center mb-4"><div className="font-bold text-slate-700 flex items-center gap-2"><Icon d={ICONS.Chart} size={16}/> 走勢</div><div className="flex bg-slate-100 rounded p-1"><button onClick={()=>setChartMode('value')} className={`px-2 py-1 text-xs rounded ${chartMode==='value'?'bg-white shadow':''}`}>值</button><button onClick={()=>setChartMode('roi')} className={`px-2 py-1 text-xs rounded ${chartMode==='roi'?'bg-white shadow':''}`}>%</button></div></div>
                                            <div className="flex gap-1 mb-2 overflow-x-auto">{['1M','1Y','3Y','ALL'].map(r=><button key={r} onClick={()=>setTimeRange(r)} className={`px-2 py-1 text-xs rounded border ${timeRange===r?'bg-slate-800 text-white border-slate-800':'border-slate-200 text-slate-500'}`}>{r}</button>)}</div>
                                            <ResponsiveContainer width="100%" height="100%">
                                                {chartMode === 'value' ? 
                                                    <ComposedChart data={filteredData}><defs><linearGradient id="cV" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.1}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient></defs><XAxis dataKey="date" hide/><YAxis domain={['auto','auto']} hide/><Tooltip formatter={v=>formatCurrency(v)}/><Area type="monotone" dataKey="total" stroke="#3b82f6" fill="url(#cV)" strokeWidth={2}/><Line type="monotone" dataKey="benchmarkVal" stroke="#f97316" strokeDasharray="3 3" dot={false}/></ComposedChart> :
                                                    <LineChart data={filteredData}><XAxis dataKey="date" hide/><YAxis hide/><Tooltip formatter={v=>formatPercent(v)}/><Line type="monotone" dataKey="userROI" stroke="#ef4444" dot={false} strokeWidth={2}/><Line type="monotone" dataKey="benchmarkROI" stroke="#94a3b8" dot={false}/></LineChart>
                                                }
                                            </ResponsiveContainer>
                                        </Card>
                                        <Card className="p-4">
                                            <div className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon d={ICONS.Pie} size={16}/> 配置</div>
                                            <div className="h-40"><ResponsiveContainer><PieChart><Pie data={pieData} innerRadius={35} outerRadius={60} dataKey="value"><Tooltip formatter={v=>formatCurrency(v)}/>{pieData.map((e,i)=><Cell key={i} fill={e.color}/>)}</Pie></PieChart></ResponsiveContainer></div>
                                            <div className="space-y-2 text-sm">{pieData.map(d=><div key={d.name} className="flex justify-between"><div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full" style={{backgroundColor:d.color}}></span>{d.name}</div><span>{((d.value/totalStats.value)*100).toFixed(1)}%</span></div>)}</div>
                                        </Card>
                                    </div>
                                )}

                                {activeTab === 'input' && (
                                    <Card className="p-5 space-y-4 animate-fade-in">
                                        <div className="flex justify-between"><h2 className="font-bold text-slate-800">記帳</h2><Button variant="magic" size="sm" onClick={()=>setModalType('ai')}><Sparkles size={16}/> AI</Button></div>
                                        <div className="grid grid-cols-2 gap-3"><Input type="date" value={entryDate} onChange={e=>setEntryDate(e.target.value)} /><Select value={selectedAccount} onChange={e=>setSelectedAccount(e.target.value)} options={accounts.map(a=>({value:a.id,label:a.name}))} /></div>
                                        <div className="bg-slate-50 p-3 rounded border border-slate-100"><Input label="總市值" type="number" value={marketValue} onChange={e=>setMarketValue(e.target.value)} /></div>
                                        <div className="border-t pt-3"><label className="text-xs text-slate-500 mb-2 block">資金流向</label><div className="flex gap-2 mb-2"><button onClick={()=>{setFlowType('none');setInputFlow('')}} className={`flex-1 py-2 text-sm rounded border ${flowType==='none'?'bg-slate-800 text-white':'bg-white'}`}>無</button><button onClick={()=>setFlowType('deposit')} className={`flex-1 py-2 text-sm rounded border ${flowType==='deposit'?'bg-blue-600 text-white':'bg-white'}`}>存入</button><button onClick={()=>setFlowType('withdraw')} className={`flex-1 py-2 text-sm rounded border ${flowType==='withdraw'?'bg-orange-500 text-white':'bg-white'}`}>領出</button></div>{flowType!=='none'&&<Input type="number" placeholder="金額" value={inputFlow} onChange={e=>setInputFlow(e.target.value)}/>}</div>
                                        <Button onClick={addRec} className="w-full mt-2 text-lg"><Save size={20}/> 儲存</Button>
                                    </Card>
                                )}

                                {activeTab === 'records' && (
                                    <div className="space-y-3 animate-fade-in">
                                        {sortedRecords.slice().reverse().map(r=>(
                                            <div key={r.id} className="bg-white p-3 rounded-lg border flex justify-between items-center shadow-sm">
                                                <div><div className="text-sm font-bold text-slate-700">{r.date}</div><div className="text-xs text-slate-400 mt-1"><span className="bg-slate-100 px-1 rounded">{accounts.find(a=>a.id===r.accountId)?.name}</span> {r.cashFlow!==0 && <span className={r.cashFlow>0?'text-blue-500':'text-orange-500'}>{r.cashFlow>0?'+':''}{r.cashFlow}</span>}</div></div>
                                                <div className="flex items-center gap-3"><div className="font-mono">{formatCurrency(r.marketValue)}</div><button onClick={()=>delRec(r.id)} className="text-slate-300 hover:text-red-500"><Icon d={ICONS.Trash} size={18}/></button></div>
                                            </div>
                                        ))}
                                        {records.length===0 && <div className="text-center text-slate-400 py-10">尚無紀錄</div>}
                                    </div>
                                )}

                                {activeTab === 'settings' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <Card className="p-4 flex justify-between items-center"><div className="flex gap-3 items-center"><Smartphone className="text-blue-600"/><div><div className="font-bold">App 模式</div><div className="text-xs text-slate-500">安裝說明</div></div></div><Button size="sm" variant="outline" onClick={()=>setModalType('install')}>查看</Button></Card>
                                        <Card className="p-4 space-y-3"><h3 className="font-bold flex gap-2 items-center"><Database size={18}/> 資料</h3><div className="flex gap-2"><Button onClick={exportJSON} variant="outline" className="flex-1"><Download size={16}/> 備份</Button><div className="flex-1 relative"><input type="file" accept=".json" onChange={e=>{setImportFile(e.target.files[0]); setModalType('import');}} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/><Button variant="outline" className="w-full"><Upload size={16}/> 還原</Button></div></div><Button onClick={exportCSV} variant="ghost" className="w-full text-emerald-600 border border-emerald-100 bg-emerald-50">匯出 Excel (CSV)</Button></Card>
                                        <Card className="p-4 border-l-4 border-amber-400 flex justify-between items-center"><div><div className="font-bold">測試</div><div className="text-xs text-slate-500">清除或生成</div></div><div className="flex gap-2"><Button onClick={()=>setModalType('demo')} variant="warning" size="sm">生成</Button><Button onClick={()=>setModalType('clear')} variant="danger" size="sm">清空</Button></div></Card>
                                        <Card className="p-4"><h3 className="font-bold mb-2">AI Key</h3><Input type="password" value={settings.apiKey} onChange={e=>setSettings({...settings,apiKey:e.target.value})} placeholder="貼上 API Key" /></Card>
                                        <Card className="p-4 space-y-2"><h3 className="font-bold">帳號</h3>{accounts.map(a=><div key={a.id} className="flex gap-2"><input type="color" value={a.color} onChange={e=>{const n=[...accounts];n.find(x=>x.id===a.id).color=e.target.value;setAccounts(n)}} className="w-8 h-8 rounded border-none"/><Input value={a.name} onChange={e=>{const n=[...accounts];n.find(x=>x.id===a.id).name=e.target.value;setAccounts(n)}} /><button onClick={()=>{if(accounts.length>1){setAccounts(accounts.filter(x=>x.id!==a.id));setRecords(records.filter(r=>r.accountId!==a.id))}}} className="text-slate-300"><Icon d={ICONS.Trash}/></button></div>)}<Button onClick={()=>{setAccounts([...accounts, {id:Date.now(), name:'新帳號', color:'#64748b'}])}} variant="secondary" className="w-full">新增</Button></Card>
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                };

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            } catch (err) {
                document.getElementById('loader').innerHTML = '<div class="p-4 text-center text-red-500"><p class="font-bold">系統錯誤</p><p class="text-sm">'+err.message+'</p></div>';
            }
        })();
    </script>
</body>
</html>
