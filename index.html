<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <title>投資收益管家</title>
    
    <!-- 1. 樣式庫 (Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. 核心函式庫 -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- PropTypes (Recharts 依賴) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <!-- Recharts -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .border-dashed-anim { background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='8' ry='8' stroke='%23CBD5E1FF' stroke-width='2' stroke-dasharray='8%2c 8' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e"); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-screen flex flex-col overflow-hidden">

    <div id="loader" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50">
        <div class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mb-4"></div>
        <p class="text-slate-500 font-bold">正在啟動...</p>
    </div>

    <div id="root" class="flex-1 flex flex-col h-full overflow-hidden"></div>

    <script type="text/babel">
        (function() {
            try {
                const APP_VERSION = "v2.0.0";
                const { useState, useEffect, useMemo, useRef } = React;
                const R = window.Recharts || {};
                const { AreaChart, Area, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ComposedChart, PieChart, Pie, Cell, ReferenceLine } = R;

                // --- 內建台股大盤歷史數據 ---
                const TAIEX_HISTORY = {
                    "2019-01": 9932, "2019-06": 10730, "2019-12": 11997,
                    "2020-06": 11621, "2020-12": 14732,
                    "2021-06": 17755, "2021-12": 18218,
                    "2022-06": 14825, "2022-12": 14137,
                    "2023-01": 15265, "2023-06": 16915, "2023-12": 17930,
                    "2024-01": 17889, "2024-03": 20294, "2024-06": 23032, "2024-09": 22224, "2024-12": 22500,
                    "2025-01": 23800, "2025-02": 24200, "2025-03": 24500, "2025-04": 25000, 
                    "2025-05": 25500, "2025-06": 26000, "2025-07": 26500, "2025-08": 27000,
                    "2025-09": 27500, "2025-10": 28233, "2025-11": 27626, "2025-12": 28556
                };

                const getTaiexEstimate = (dateStr) => {
                    if (!dateStr) return 22000;
                    const key = dateStr.substring(0, 7); 
                    if (TAIEX_HISTORY[key]) return TAIEX_HISTORY[key];
                    const year = parseInt(dateStr.substring(0, 4));
                    if (year === 2025) return 26000;
                    if (year > 2025) return 28000;
                    return 20000; 
                };

                // --- XIRR 核心演算法 (Newton-Raphson) ---
                function calculateXIRR(values, dates, guess = 0.1) {
                    if (values.length !== dates.length || values.length === 0) return 0;
                    
                    // 檢查是否有正負現金流
                    let hasPos = false, hasNeg = false;
                    for (let v of values) {
                        if (v > 0) hasPos = true;
                        if (v < 0) hasNeg = true;
                    }
                    if (!hasPos || !hasNeg) return 0;

                    const tol = 1e-6; // 誤差容許值
                    const maxIter = 100; // 最大迭代次數
                    let x0 = guess;
                    const t0 = new Date(dates[0]).getTime();
                    const durs = dates.map(d => (new Date(d).getTime() - t0) / 31536000000); // 轉換為年

                    for (let i = 0; i < maxIter; i++) {
                        let fValue = 0;
                        let fDerivative = 0;
                        for (let j = 0; j < values.length; j++) {
                            const v = values[j];
                            const d = durs[j];
                            const base = 1 + x0;
                            if (base <= 0) { x0 = 0.01; break; } // 防止負基數
                            fValue += v / Math.pow(base, d);
                            fDerivative += -d * v / Math.pow(base, d + 1);
                        }
                        
                        if (Math.abs(fValue) < tol) return x0;
                        if (Math.abs(fDerivative) < tol) break;
                        const newX = x0 - fValue / fDerivative;
                        if (Math.abs(newX - x0) < tol) return newX;
                        x0 = newX;
                    }
                    return x0; // 回傳小數 (例如 0.15 代表 15%)
                }

                // --- 圖示系統 ---
                const ICON_PATHS = {
                    TrendingUp: ["M23 6L13.5 15.5L8.5 10.5L1 18", "M17 6H23V12"], 
                    Trash2: ["M3 6H21", "M19 6V20C19 21.1 18.1 22 17 22H7C5.9 22 5 21.1 5 20V6", "M8 6V4C8 2.9 8.9 2 10 2H14C15.1 2 16 2.9 16 4V6", "M10 11V17", "M14 11V17"],
                    Save: ["M19 21H5C3.9 21 3 20.1 3 19V5C3 3.9 3.9 3 5 3H16L21 8V19C21 20.1 20.1 21 19 21Z", "M17 21V13H7V21", "M7 3V8H15"],
                    BarChart2: ["M18 20V10", "M12 20V4", "M6 20V14"],
                    Sparkles: ["M12 3L10.088 8.736L4.352 10.648L10.088 12.56L12 18.296L13.912 12.56L19.648 10.648L13.912 8.736L12 3Z"],
                    Loader2: ["M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3"],
                    Database: ["M12 5C16.97 5 21 3.66 21 2C21 0.34 16.97 -1 12 -1C7.03 -1 3 0.34 3 2C3 3.66 7.03 5 12 5Z", "M21 12C21 13.66 16.97 15 12 15C7.03 15 3 13.66 3 12", "M3 5V19C3 20.66 7.03 22 12 22C16.97 22 21 20.66 21 19V5"],
                    Check: ["M20 6L9 17L4 12"],
                    X: ["M18 6L6 18", "M6 6L18 18"],
                    Download: ["M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15", "M7 10L12 15L17 10", "M12 15V3"],
                    Upload: ["M21 15V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V15", "M17 8L12 3L7 8", "M12 3V15"],
                    AlertTriangle: ["M10.29 3.86L1.82 18C1.64537 18.3024 1.55296 18.6453 1.55199 18.9945C1.55103 19.3437 1.64155 19.6871 1.81442 19.9905C1.98729 20.2939 2.23659 20.5467 2.5377 20.7239C2.8388 20.9011 3.18126 20.9967 3.53 21H20.47C20.8187 20.9967 21.1612 20.9011 21.4623 20.7239C21.7634 20.5467 22.0127 20.2939 22.1856 19.9905C22.3584 19.6871 22.449 19.3437 22.448 18.9945C22.447 18.6453 22.3546 18.3024 22.18 18L13.71 3.86C13.5317 3.56611 13.2807 3.32312 12.9812 3.15449C12.6817 2.98587 12.3437 2.89728 12 2.89728C11.6563 2.89728 11.3183 2.98587 11.0188 3.15449C10.7193 3.32312 10.4683 3.56611 10.29 3.86V3.86Z", "M12 9V13", "M12 17H12.01"],
                    Smartphone: ["M5 2H19C20.1 2 21 2.9 21 4V20C21 21.1 20.1 22 19 22H5C3.9 22 3 21.1 3 20V4C3 2.9 3.9 2 5 2Z", "M12 18H12.01"],
                    Maximize: ["M8 3H5C4.46957 3 3.96086 3.21071 3.58579 3.58579C3.21071 3.96086 3 4.46957 3 5V8", "M16 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V8", "M21 16V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H16", "M8 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V16"],
                    Minimize: ["M8 3V6H3", "M21 8H18V3", "M21 16H18V21", "M3 16H6V21"],
                    Eye: ["M1 12S5 4 12 4S23 12 23 12S19 20 12 20S1 12 1 12Z", "M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z"],
                    EyeOff: ["M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94", "M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 012.16 3.19", "M1 1L23 23"],
                    PieChart: ["M21.21 15.89A10 10 0 118 2.83", "M22 12A10 10 0 0012 2V12H22Z"],
                    Image: ["M21 19V5C21 3.9 20.1 3 19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19ZM8.5 13.5L11 16.5L14.5 12L19 18H5L8.5 13.5Z"],
                    Activity: ["M22 12h-4l-3 9L9 3l-3 9H2"],
                    RefreshCw: ["M23 4v6h-6", "M1 20v-6h6", "M3.51 9a9 9 0 0 1 14.85-3.36L23 10", "M1 14l4.64 4.36A9 9 0 0 0 20.49 15"],
                    Briefcase: ["M20 7h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V9c0-1.1-.9-2-2-2zM10 4h4v3h-4V4z"],
                    CreditCard: ["M21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H3V12h18v6zM3 8V6h18v2H3z"]
                };

                const Icon = ({ d, size = 24, className = "" }) => (
                    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                        {Array.isArray(d) ? d.map((p, i) => <path key={i} d={p} />) : <path d={d} />}
                    </svg>
                );

                const Icons = {};
                Object.keys(ICON_PATHS).forEach(key => {
                    Icons[key] = (props) => <Icon d={ICON_PATHS[key]} {...props} />;
                });
                const { TrendingUp, Trash2, Save, BarChart2, Sparkles, Loader2, Database, Check, X, Download, Upload, AlertTriangle, Smartphone, Maximize, Minimize, Eye, EyeOff, PieChart: PieIcon, Image: ImageIcon, Activity, RefreshCw, Briefcase, CreditCard } = Icons;

                const Card = ({ children, className = "" }) => <div className={`bg-white rounded-xl shadow-sm border border-slate-200 ${className}`}>{children}</div>;
                
                const Button = ({ onClick, children, variant = "primary", className = "", disabled = false, size = "md" }) => {
                    const baseStyle = "rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed active:scale-95 transform select-none";
                    const sizes = { sm: "px-3 py-1.5 text-sm", md: "px-4 py-3" };
                    const variants = {
                        primary: "bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800",
                        secondary: "bg-slate-100 text-slate-700 hover:bg-slate-200 active:bg-slate-300",
                        danger: "bg-red-50 text-red-600 hover:bg-red-100 active:bg-red-200",
                        outline: "border border-slate-300 text-slate-600 hover:bg-slate-50",
                        magic: "bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-md hover:opacity-90",
                        warning: "bg-amber-100 text-amber-700 hover:bg-amber-200 border border-amber-200",
                        ghost: "text-slate-500 hover:bg-slate-100 hover:text-slate-900",
                    };
                    return <button onClick={onClick} className={`${baseStyle} ${sizes[size]} ${variants[variant]} ${className}`} disabled={disabled}>{children}</button>;
                };

                const Input = ({ label, value, onChange, type = "text", placeholder = "" }) => (
                    <div className="flex flex-col gap-1 w-full">{label && <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>}<input type={type} value={value} onChange={onChange} placeholder={placeholder} className="border border-slate-300 rounded-lg px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-base bg-white appearance-none" /></div>
                );

                const Select = ({ label, value, onChange, options }) => (
                    <div className="flex flex-col gap-1 w-full">{label && <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">{label}</label>}<div className="relative"><select value={value} onChange={onChange} className="border border-slate-300 rounded-lg px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full text-base bg-white appearance-none">{options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select><div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><svg className="fill-current h-4 w-4" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg></div></div></div>
                );

                const App = () => {
                    const safeLoad = (key, def) => { try { const s = localStorage.getItem(key); return s ? JSON.parse(s) : def; } catch { return def; } };
                    const [settings, setSettings] = useState(() => safeLoad('inv_settings', { benchmarkName: '台股加權指數', apiKey: '', lastBackupDate: null }));
                    const [accounts, setAccounts] = useState(() => safeLoad('inv_accounts', [{ id: 'a1', name: '帳號 A', color: '#3b82f6' }, { id: 'a2', name: '帳號 B', color: '#10b981' }, { id: 'a3', name: '帳號 C', color: '#f59e0b' }]));
                    const [records, setRecords] = useState(() => safeLoad('inv_records', []));
                    const [benchmarkData, setBenchmarkData] = useState(() => safeLoad('inv_benchmark_data', {}));

                    const [activeTab, setActiveTab] = useState('dashboard');
                    const [dashboardMode, setDashboardMode] = useState('assets'); 
                    const [timeRange, setTimeRange] = useState('ALL');
                    const [isFullscreen, setIsFullscreen] = useState(false);
                    const [notification, setNotification] = useState(null);
                    const [modalType, setModalType] = useState(null);
                    const [showBackupAlert, setShowBackupAlert] = useState(false);
                    const [isPrivacyMode, setIsPrivacyMode] = useState(false);
                    const [isFetchingBenchmark, setIsFetchingBenchmark] = useState(false);
                    
                    // Input States
                    const [inputType, setInputType] = useState('balance'); // 'balance' | 'flow'
                    const [entryDate, setEntryDate] = useState(new Date().toISOString().split('T')[0]);
                    const [selectedAccount, setSelectedAccount] = useState(accounts.length>0 ? accounts[0].id : '');
                    const [marketValue, setMarketValue] = useState('');
                    const [inputFlow, setInputFlow] = useState('');
                    const [flowType, setFlowType] = useState('deposit');
                    const [benchmarkInput, setBenchmarkInput] = useState('');
                    
                    const [isAiProcessing, setIsAiProcessing] = useState(false);
                    const [pasteContent, setPasteContent] = useState('');
                    const [aiImage, setAiImage] = useState(null); 
                    const [aiError, setAiError] = useState(null);
                    const [importFile, setImportFile] = useState(null);

                    const PIE_COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#6366f1'];

                    useEffect(() => { try{localStorage.setItem('inv_accounts', JSON.stringify(accounts));}catch{} }, [accounts]);
                    useEffect(() => { try{localStorage.setItem('inv_records', JSON.stringify(records));}catch{} }, [records]);
                    useEffect(() => { try{localStorage.setItem('inv_settings', JSON.stringify(settings));}catch{} }, [settings]);
                    useEffect(() => { try{localStorage.setItem('inv_benchmark_data', JSON.stringify(benchmarkData));}catch{} }, [benchmarkData]);
                    useEffect(() => { if(accounts.length>0 && !accounts.find(a=>a.id===selectedAccount)) setSelectedAccount(accounts[0].id); }, [accounts, selectedAccount]);
                    useEffect(() => { const h=()=>setIsFullscreen(!!document.fullscreenElement); document.addEventListener("fullscreenchange",h); return ()=>document.removeEventListener("fullscreenchange",h); }, []);
                    useEffect(() => { if(records.length===0)return; const last=settings.lastBackupDate?new Date(settings.lastBackupDate):null; if(!last||(new Date()-last>30*86400000)) setShowBackupAlert(true); else setShowBackupAlert(false); }, [settings.lastBackupDate, records.length]);
                    useEffect(() => { document.getElementById('loader').style.display='none'; }, []);

                    const fetchBenchmarkData = async (force = false) => {
                        if (!force && Object.keys(benchmarkData).length > 100) return;
                        setIsFetchingBenchmark(true);
                        try {
                            const url = "https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/%5ETWII?interval=1d&range=5y";
                            const res = await fetch(url);
                            if (!res.ok) throw new Error("Network response was not ok");
                            const json = await res.json();
                            const result = json.chart.result[0];
                            const quotes = result.indicators.quote[0].close;
                            const timestamps = result.timestamp;
                            const newMap = { ...benchmarkData };
                            timestamps.forEach((t, i) => {
                                if (quotes[i]) {
                                    const date = new Date(t * 1000).toISOString().split('T')[0];
                                    newMap[date] = quotes[i];
                                }
                            });
                            setBenchmarkData(newMap);
                            if (force) showToast("大盤資料已更新");
                        } catch (e) {
                            console.error("Fetch benchmark failed:", e);
                            if (force) showToast("更新失敗，請稍後再試");
                        } finally {
                            setIsFetchingBenchmark(false);
                        }
                    };

                    useEffect(() => { fetchBenchmarkData(); }, []);

                    const getTaiexValue = (dateStr) => {
                        if (!dateStr) return null;
                        if (benchmarkData[dateStr]) return benchmarkData[dateStr];
                        const d = new Date(dateStr);
                        for (let i = 0; i < 7; i++) {
                            d.setDate(d.getDate() - 1);
                            const prevDate = d.toISOString().split('T')[0];
                            if (benchmarkData[prevDate]) return benchmarkData[prevDate];
                        }
                        return null; 
                    };

                    const showToast = (m) => { setNotification(m); setTimeout(()=>setNotification(null), 3000); };
                    const toggleFs = () => { if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else if(document.exitFullscreen) document.exitFullscreen().catch(()=>{}); };
                    const fmtCur = (v) => isPrivacyMode ? '****' : new Intl.NumberFormat('zh-TW',{maximumFractionDigits:0}).format(v);
                    const fmtPct = (v) => `${v>0?'+':''}${v?.toFixed(2)}%`;
                    const fmtAxis = (v) => {
                        if (isPrivacyMode) return '';
                        if (v >= 100000000) return `${(v/100000000).toFixed(1)}億`;
                        if (v >= 10000) return `${(v/10000).toFixed(1)}萬`; 
                        return v;
                    };
                    const fmtDateAxis = (d) => {
                        if (!d) return '';
                        return d.slice(2).replace(/-/g, '/');
                    };

                    const sortedRecs = useMemo(()=>[...records].sort((a,b)=>new Date(a.date)-new Date(b.date)), [records]);
                    
                    useEffect(()=>{ 
                        if(sortedRecs.length>0 && !benchmarkInput) {
                            const lastRec = sortedRecs[sortedRecs.length-1];
                            const val = lastRec.benchmarkValue || getTaiexValue(lastRec.date) || getTaiexEstimate(lastRec.date);
                            if(val) setBenchmarkInput(val.toFixed(0)); 
                        }
                    },[sortedRecs, benchmarkData]);

                    const accStats = useMemo(()=>{
                        const res={}; accounts.forEach(a=>res[a.id]={name:a.name,color:a.color,currentValue:0,totalInvested:0,roi:0});
                        accounts.forEach(a=>{
                            const rs=sortedRecs.filter(r=>r.accountId===a.id);
                            if(rs.length===0) return;
                            const f=rs[0];
                            const flows=rs.reduce((s,r)=>s+parseFloat(r.cashFlow),0);
                            const cur=parseFloat(rs[rs.length-1].marketValue);
                            // 總投入 = (sum of all negative cashflows abs)
                            // 這裡簡化: 假設初始值也是投入. 
                            // 更好的方式: 遍歷所有紀錄, 累加所有負值流向. 
                            // 初始餘額 = 首筆 (MarketValue - CashFlow). 如果 > 0 視為初始投入.
                            const init = parseFloat(f.marketValue) - parseFloat(f.cashFlow);
                            let totalDep = (init > 0) ? init : 0;
                            rs.forEach(r => {
                                if (r.cashFlow > 0) totalDep += r.cashFlow; // Deposit is + in our new logic? Wait.
                                // In new logic: Deposit is +CF, Withdrawal is -CF? 
                                // Let's check handleAdd: flowType==='deposit' ? abs : -abs. Yes.
                                // So Deposit is positive.
                            });
                            
                            // 總獲利 = (現值 + 總領回) - 總投入
                            // 總領回 = sum of abs(negative flows)
                            let totalWith = 0;
                            rs.forEach(r => { if (r.cashFlow < 0) totalWith += Math.abs(r.cashFlow); });
                            
                            // ROI = Profit / Invested
                            const profit = (cur + totalWith) - totalDep;
                            const roi = totalDep ? (profit / totalDep) * 100 : 0;

                            res[a.id]={...res[a.id], currentValue:cur, totalInvested:totalDep, roi:roi, profit: profit};
                        });
                        return res;
                    },[accounts,sortedRecs]);

                    const totalStats = useMemo(()=>{
                        let v=0, i=0, p=0; 
                        Object.values(accStats).forEach(s=>{
                            v+=s.currentValue;
                            i+=s.totalInvested;
                            p+=s.profit;
                        });
                        return {value:v, invested:i, pl:p, roi:i?(p/i)*100:0};
                    },[accStats]);

                    const pieData = useMemo(()=>Object.values(accStats).filter(s=>s.currentValue>0).map((s,i)=>({name:s.name,value:s.currentValue,color:s.color||PIE_COLORS[i%PIE_COLORS.length]})),[accStats]);

                    // --- 圖表數據處理核心 (XIRR + 獲利金額 PK) ---
                    const chartData = useMemo(()=>{
                        if(sortedRecs.length===0) return [];
                        const dates=[...new Set(sortedRecs.map(r=>r.date))].sort();
                        const res=[];
                        
                        // 計算「大盤模擬」
                        // 假設每一筆現金流都拿去買大盤，現在值多少？
                        // 1. 初始: 每一帳戶的第一筆 (MV - CF) 視為買入
                        // 2. 之後: 每一筆 CF，若是 + 則買入，若是 - 則賣出
                        
                        // 我們需要維護一個 "Simulated Index Units"
                        let indexUnits = 0;
                        
                        // 預處理：找出每個帳戶的起始點，加入初始資金
                        const firstDate = dates[0];
                        const startIdxVal = getTaiexValue(firstDate) || getTaiexEstimate(firstDate) || 10000;
                        
                        accounts.forEach(a => {
                            const rs = sortedRecs.filter(r => r.accountId === a.id && r.date === firstDate);
                            if(rs.length > 0) {
                                const f = rs[0];
                                const init = parseFloat(f.marketValue) - parseFloat(f.cashFlow); 
                                if (init > 0) {
                                    indexUnits += (init / startIdxVal);
                                }
                            }
                        });

                        // 累積數據
                        let cumWith = 0; // 累計領回 (User)
                        let cumDep = 0;  // 累計投入 (User)
                        
                        // 用於計算大盤模擬的累計領回 (假設賣出大盤拿到現金)
                        let benchmarkCumWith = 0; 
                        let benchmarkCumDep = 0; // 其實等於 cumDep

                        // 處理每日數據
                        dates.forEach((d)=>{
                            let userMV = 0;
                            let dailyFlow = 0; // 當日總現金流 (所有帳戶)
                            
                            // 取得當日大盤
                            const bRec = sortedRecs.filter(r=>r.date<=d && r.benchmarkValue).pop();
                            let idxVal = bRec ? parseFloat(bRec.benchmarkValue) : (getTaiexValue(d) || getTaiexEstimate(d));
                            if (!idxVal) idxVal = startIdxVal; // 防呆

                            accounts.forEach(a=>{
                                const rs=sortedRecs.filter(r=>r.accountId===a.id && r.date<=d);
                                if(rs.length>0) {
                                    const l=rs[rs.length-1];
                                    userMV += parseFloat(l.marketValue);
                                    
                                    // 檢查當日是否有現金流 (只看當天)
                                    const todays = records.filter(r => r.accountId === a.id && r.date === d);
                                    todays.forEach(tr => {
                                        // 這裡有個 bug: sortedRecs 是去重後的嗎？ 不，sortedRecs 是所有紀錄排序
                                        // 但上面 map dates 是 unique dates
                                        // 我們需要累加「截至今日」的所有流向嗎？
                                        // 不，這裡要即時模擬買入大盤，所以要依序處理
                                    });
                                }
                            });
                            
                            // 重來：依序遍歷 dates 處理流向
                            // 找出發生在 date d 的所有交易
                            const todaysRecs = records.filter(r => r.date === d);
                            todaysRecs.forEach(r => {
                                const cf = parseFloat(r.cashFlow);
                                // User Stats
                                if (cf > 0) cumDep += cf;
                                if (cf < 0) cumWith += Math.abs(cf);
                                
                                // Benchmark Simulation
                                // 買入/賣出指數
                                // CF > 0 (Deposit): Buy index
                                // CF < 0 (Withdraw): Sell index
                                if (cf !== 0) {
                                    const units = cf / idxVal; 
                                    // 存入 100 -> 買入 units (units 增加)
                                    // 領出 100 (cf=-100) -> 賣出 units (units 減少)
                                    indexUnits += units;
                                    
                                    // 修正 Benchmark 獲利公式：
                                    // 它的「已領回」等於 User 的已領回 (因為我們假設同樣金額進出)
                                    // 它的「總投入」等於 User 的總投入
                                }
                            });

                            // 計算當日 User 獲利
                            // Profit = (MV + CumWithdraw) - CumDeposit
                            // 注意：CumDeposit 包含初始資金嗎？ 上面只加了 CF。
                            // 我們需要加上初始資金
                            let totalInvested = cumDep;
                            accounts.forEach(a => {
                                const fr = sortedRecs.filter(r => r.accountId === a.id)[0];
                                if (fr) {
                                    const init = parseFloat(fr.marketValue) - parseFloat(fr.cashFlow);
                                    if(init > 0) totalInvested += init;
                                }
                            });
                            
                            const userProfit = (userMV + cumWith) - totalInvested;
                            
                            // 計算當日 Benchmark 獲利
                            // Bench MV = indexUnits * idxVal
                            // Bench Profit = (BenchMV + CumWithdraw) - TotalInvested
                            const benchMV = indexUnits * idxVal;
                            const benchProfit = (benchMV + cumWith) - totalInvested;

                            const pt = {
                                date: d, 
                                userProfit: userProfit,
                                benchProfit: benchProfit,
                                total: userMV,
                                benchmarkVal: idxVal
                            };
                            res.push(pt);
                        });
                        
                        return res;
                    },[sortedRecs, accounts, benchmarkData]); 

                    // 計算總體 XIRR
                    const portfolioXIRR = useMemo(() => {
                        // 構建現金流: [date, amount]
                        // 1. 初始投入 (視為負)
                        // 2. 中途存入 (視為負)
                        // 3. 中途領出 (視為正)
                        // 4. 期末市值 (視為正)
                        const flows = [];
                        const dates = [];
                        
                        // 找出所有帳戶的起始
                        accounts.forEach(a => {
                            const rs = sortedRecs.filter(r => r.accountId === a.id);
                            if(rs.length > 0) {
                                const f = rs[0];
                                const init = parseFloat(f.marketValue) - parseFloat(f.cashFlow);
                                if(init > 0) {
                                    flows.push(-init);
                                    dates.push(f.date);
                                }
                            }
                        });
                        
                        // 所有中間流向
                        records.forEach(r => {
                            const cf = parseFloat(r.cashFlow);
                            if(cf !== 0) {
                                // Deposit (User inputs +) -> XIRR Outflow (-)
                                // Withdraw (User inputs -) -> XIRR Inflow (+)
                                // 但我的邏輯是: flowType='deposit' => cashFlow = +abs
                                // flowType='withdraw' => cashFlow = -abs
                                // 所以: deposit (+100) -> 應該變成 -100
                                // withdraw (-50) -> 應該變成 +50
                                flows.push(-cf); 
                                dates.push(r.date);
                            }
                        });
                        
                        // 期末市值
                        if (totalStats.value > 0) {
                            flows.push(totalStats.value);
                            dates.push(new Date().toISOString().split('T')[0]); // Today
                        }
                        
                        return calculateXIRR(flows, dates);
                    }, [records, totalStats, accounts]);

                    const filteredData = useMemo(()=>{
                        if(chartData.length===0 || timeRange==='ALL') return chartData;
                        const last=new Date(chartData[chartData.length-1].date);
                        const cut=new Date(last);
                        if(timeRange==='1D') cut.setDate(last.getDate()-2);
                        else if(timeRange==='1W') cut.setDate(last.getDate()-7);
                        else if(timeRange==='1Y') cut.setFullYear(last.getFullYear()-1);
                        else if(timeRange==='3Y') cut.setFullYear(last.getFullYear()-3);
                        else if(timeRange==='5Y') cut.setFullYear(last.getFullYear()-5);
                        return chartData.filter(d=>new Date(d.date)>=cut);
                    },[chartData,timeRange]);

                    const handleAdd = () => {
                        if(!entryDate||!selectedAccount) return showToast("請填寫日期與帳號");
                        
                        if(inputType === 'balance' && !marketValue) return showToast("請輸入總市值");
                        if(inputType === 'flow' && !inputFlow) return showToast("請輸入存提金額");

                        let finalMV = 0;
                        let finalCF = 0;
                        const bVal = benchmarkInput ? parseFloat(benchmarkInput) : (getTaiexValue(entryDate) || getTaiexEstimate(entryDate));

                        const existingRecIndex = records.findIndex(r => r.date === entryDate && r.accountId === selectedAccount);
                        let existingRec = existingRecIndex >= 0 ? records[existingRecIndex] : null;

                        if (inputType === 'balance') {
                            finalMV = parseFloat(marketValue);
                            finalCF = existingRec ? existingRec.cashFlow : 0;
                        } else {
                            const amt = parseFloat(inputFlow);
                            // Deposit = +, Withdraw = -
                            finalCF = flowType === 'deposit' ? Math.abs(amt) : -Math.abs(amt);
                            
                            if (existingRec) {
                                finalMV = existingRec.marketValue; 
                            } else {
                                const prevRec = sortedRecs.filter(r => r.accountId === selectedAccount && r.date < entryDate).pop();
                                const prevMV = prevRec ? parseFloat(prevRec.marketValue) : 0;
                                // 存入: 市值應該增加 (prev + amt)
                                // 領出: 市值應該減少 (prev - amt) -> (prev + (-amt))
                                finalMV = prevMV + finalCF; 
                                showToast(`已自動推算市值: ${finalMV}`);
                            }
                        }

                        const nr = {
                            id: existingRec ? existingRec.id : Date.now(), 
                            date: entryDate, 
                            accountId: selectedAccount, 
                            marketValue: finalMV, 
                            cashFlow: finalCF, 
                            benchmarkValue: bVal
                        };

                        setRecords(p => {
                            const n = [...p];
                            if(existingRecIndex >= 0) n[existingRecIndex] = nr;
                            else n.push(nr);
                            return n;
                        });

                        setMarketValue(''); setInputFlow(''); 
                        showToast("已儲存");
                    };

                    const exportJSON = () => {
                        const d={accounts,records,settings:{...settings,lastBackupDate:new Date().toISOString()}};
                        const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(d)); a.download=`backup_${d.settings.lastBackupDate.split('T')[0]}.json`;
                        a.click(); setSettings(d.settings); setShowBackupAlert(false); showToast("備份已下載");
                    };

                    const handleImportExecute = () => {
                        if (!importFile) return;
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const d = JSON.parse(e.target.result);
                                if(d.accounts) setAccounts(d.accounts);
                                if(d.records) setRecords(d.records);
                                if(d.settings) setSettings(d.settings);
                                setModalType(null);
                                showToast("資料已還原");
                            } catch (err) {
                                showToast("檔案格式錯誤");
                            }
                        };
                        reader.readAsText(importFile);
                    };

                    const handleImageUpload = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                                setAiImage({ base64: reader.result.split(',')[1], type: file.type, preview: reader.result });
                            };
                            reader.readAsDataURL(file);
                        }
                    };

                    const handlePaste = (e) => {
                        const items = e.clipboardData.items;
                        for (let i = 0; i < items.length; i++) {
                            if (items[i].type.indexOf("image") !== -1) {
                                const blob = items[i].getAsFile();
                                const reader = new FileReader();
                                reader.onloadend = () => {
                                    setAiImage({ base64: reader.result.split(',')[1], type: blob.type, preview: reader.result });
                                };
                                reader.readAsDataURL(blob);
                                e.preventDefault();
                            }
                        }
                    };

                    const handleAI = async () => {
                        let currentKey = settings.apiKey;
                        if (!currentKey) {
                            const inputKey = prompt("請輸入 Gemini API Key (只需輸入一次，將自動儲存):");
                            if (!inputKey) return setAiError("需要 API Key 才能使用 AI 功能");
                            setSettings(prev => ({ ...prev, apiKey: inputKey }));
                            currentKey = inputKey; 
                        }

                        if(!pasteContent && !aiImage) return setAiError("請提供文字或圖片");
                        setIsAiProcessing(true);
                        setAiError(null);
                        
                        const existingAccountNames = accounts.map(a => a.name).join(', ');

                        try {
                            const parts = [];
                            const promptBase = `
                            你是一個投資數據解析器。請分析提供的圖片或文字，其中包含「多個日期」與「多個帳戶」的投資紀錄。
                            目前 App 內已有的帳戶名稱：[${existingAccountNames}]。
                            
                            請針對每一筆找到的紀錄執行以下動作：
                            1. 識別日期 (格式 YYYY-MM-DD)。
                            2. 識別帳戶名稱 (Account Name)。如果名稱與上述現有帳戶相似，請使用現有名稱。
                            3. 計算該帳戶當日的「總市值」(Total Market Value) = 證券/庫存市值 + 現金/存款/交割款。
                            4. 識別大盤指數 (Benchmark) 數值 (若有)。

                            回傳格式必須是 JSON Array (陣列)。移除數字中的逗號。不要包含任何 Markdown 格式或額外文字。
                            範例結構：[{"date":"2023-10-01","accountName":"帳戶A","marketValue":1000000,"benchmarkValue":16500}]
                            `;

                            if (aiImage) {
                                parts.push({ text: promptBase });
                                parts.push({ inlineData: { mimeType: aiImage.type, data: aiImage.base64 } });
                            } else {
                                parts.push({ text: `${promptBase}\n\n待解析文字：\n"${pasteContent}"` });
                            }

                            const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`,{
                                method:"POST",headers:{"Content-Type":"application/json"},
                                body:JSON.stringify({contents:[{parts}]})
                            });
                            
                            if(!res.ok) {
                                const errData = await res.json().catch(() => ({}));
                                throw new Error(errData.error?.message || res.statusText || "API Error");
                            }

                            const d=await res.json();
                            let text = d.candidates[0].content.parts[0].text;
                            
                            const jsonRegex = /\[[\s\S]*\]|{[:\s\S]*}/;
                            const match = text.match(jsonRegex);
                            if (match) {
                                text = match[0];
                            } else {
                                text = text.replace(/```json/g,'').replace(/```/g,'').trim();
                            }
                            
                            let parsedData;
                            try {
                                parsedData = JSON.parse(text);
                            } catch (e) {
                                console.error("Raw AI response:", d.candidates[0].content.parts[0].text);
                                throw new Error("AI 回傳格式錯誤，無法解析 JSON");
                            }

                            if (!Array.isArray(parsedData)) {
                                parsedData = [parsedData];
                            }
                            
                            if(parsedData.length === 0) throw new Error("未找到任何有效數據");

                            const newRecs = [];
                            let updatedAccounts = [...accounts];
                            let addedCount = 0;

                            parsedData.forEach(item => {
                                if(!item.date || !item.marketValue) return;

                                let acc = updatedAccounts.find(a => a.name === item.accountName);
                                if (!acc) {
                                    const newId = 'acc_' + Date.now() + Math.random().toString(36).substr(2, 5);
                                    acc = { 
                                        id: newId, 
                                        name: item.accountName || '未知帳戶', 
                                        color: '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0') 
                                    };
                                    updatedAccounts.push(acc);
                                }

                                const bVal = item.benchmarkValue || getTaiexValue(item.date) || getTaiexEstimate(item.date);

                                newRecs.push({
                                    id: Date.now() + Math.random(),
                                    date: item.date,
                                    accountId: acc.id,
                                    marketValue: item.marketValue,
                                    cashFlow: 0, 
                                    benchmarkValue: bVal
                                });
                                addedCount++;
                            });

                            setAccounts(updatedAccounts);
                            setRecords(prev => {
                                let next = [...prev];
                                newRecs.forEach(nr => {
                                    const idx = next.findIndex(r => r.date === nr.date && r.accountId === nr.accountId);
                                    if (idx >= 0) {
                                        next[idx] = { ...next[idx], marketValue: nr.marketValue, benchmarkValue: nr.benchmarkValue || next[idx].benchmarkValue };
                                    } else {
                                        next.push(nr);
                                    }
                                });
                                return next;
                            });

                            setModalType(null); 
                            setAiImage(null);
                            setPasteContent('');
                            showToast(`成功解析 ${addedCount} 筆資料`);

                        } catch (e) { console.error(e); setAiError("解析失敗: " + e.message); } finally { setIsAiProcessing(false); }
                    };

                    const Modal = ({ title, onClose, children }) => (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4" onClick={onClose}><div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-fade-in" onClick={e=>e.stopPropagation()}><div className="p-5 border-b border-slate-100 flex justify-between items-center"><h3 className="text-xl font-bold text-slate-800">{title}</h3><button onClick={onClose} className="text-slate-400"><X size={24}/></button></div><div className="p-6">{children}</div></div></div>
                    );

                    return (
                        <div className="max-w-lg mx-auto w-full h-full relative flex flex-col bg-slate-50">
                            {notification && <div className="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-full shadow-lg z-50 text-sm flex items-center gap-2 animate-fade-in"><Check size={16} className="text-green-400"/>{notification}</div>}
                            
                            {/* Modals */}
                            {modalType === 'clear' && <Modal title="清空資料" onClose={()=>setModalType(null)}><p className="text-center mb-4 text-red-600 font-bold">此動作無法復原！</p><div className="flex gap-3"><Button onClick={()=>setModalType(null)} variant="secondary" className="flex-1">取消</Button><Button onClick={()=>{setRecords([]);setAccounts([{id:'a1',name:'帳號 A',color:'#3b82f6'}]);setModalType(null);showToast("已重置")}} variant="danger" className="flex-1">清空</Button></div></Modal>}
                            {modalType === 'install' && <Modal title="安裝教學" onClose={()=>setModalType(null)}><div className="space-y-3 text-sm text-slate-600"><p><strong>iOS:</strong> Safari 分享按鈕 &gt; 加入主畫面</p><p><strong>Android:</strong> Chrome 選單 &gt; 加入主畫面</p><Button onClick={()=>setModalType(null)} className="w-full mt-2">好</Button></div></Modal>}
                            {modalType === 'import' && <Modal title="還原備份" onClose={()=>{setModalType(null);setImportFile(null)}}><p className="text-center mb-4 text-slate-600">確定要從 {importFile?.name} 還原資料嗎？現有資料將被覆蓋。</p><div className="flex gap-3"><Button onClick={()=>{setModalType(null);setImportFile(null)}} variant="secondary" className="flex-1">取消</Button><Button onClick={handleImportExecute} variant="primary" className="flex-1">還原</Button></div></Modal>}
                            
                            {modalType === 'ai' && <Modal title="AI 智慧貼上 (多帳戶/多日)" onClose={()=>{setModalType(null);setAiImage(null);setPasteContent('');setAiError(null);}}>
                                <div className="space-y-4">
                                    <div className="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center hover:bg-slate-50 transition relative" onPaste={handlePaste}>
                                        {aiImage ? (
                                            <div className="relative">
                                                <img src={aiImage.preview} className="max-h-48 mx-auto rounded shadow-sm" />
                                                <button onClick={()=>setAiImage(null)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow"><X size={16}/></button>
                                            </div>
                                        ) : (
                                            <div className="py-4 cursor-pointer" onClick={()=>document.getElementById('ai-img-upload').click()}>
                                                <div className="mx-auto w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-2"><ImageIcon size={24}/></div>
                                                <p className="text-sm font-medium text-slate-700">點擊上傳 或 Ctrl+V 貼上圖片</p>
                                                <p className="text-xs text-slate-400 mt-1">支援含有多日、多帳戶的對帳單截圖</p>
                                            </div>
                                        )}
                                        <input id="ai-img-upload" type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                                    </div>
                                    
                                    <div className="relative">
                                        <div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div>
                                        <div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-500">或輸入文字</span></div>
                                    </div>

                                    <textarea className="w-full h-20 border border-slate-300 p-3 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" value={pasteContent} onChange={e=>setPasteContent(e.target.value)} placeholder="例如: 10/1 台新 50萬, 玉山 30萬; 10/2 台新 51萬..." />
                                    
                                    {aiError && <div className="bg-red-50 text-red-600 text-xs p-2 rounded flex items-center gap-1"><AlertTriangle size={12}/> {aiError}</div>}
                                    
                                    <div className="flex justify-end gap-2 pt-2">
                                        <Button onClick={()=>{setModalType(null);setAiImage(null);}} variant="secondary">取消</Button>
                                        <Button onClick={handleAI} variant="magic" disabled={isAiProcessing}>{isAiProcessing?<><Loader2 className="animate-spin" size={18}/> 解析中...</> : <><Sparkles size={18}/> 開始解析</>}</Button>
                                    </div>
                                </div>
                            </Modal>}

                            {/* Header */}
                            <header className="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 py-3 safe-top flex flex-col gap-3 shadow-sm flex-shrink-0">
                                <div className="flex justify-between items-center">
                                    <div className="flex items-center gap-2"><span className="bg-blue-600 text-white p-1 rounded"><TrendingUp size={18}/></span><h1 className="font-bold text-slate-800 text-lg">投資收益管家</h1></div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setIsPrivacyMode(!isPrivacyMode)} className="text-slate-400 p-2 rounded-full hover:bg-slate-100">{isPrivacyMode?<EyeOff size={20}/>:<Eye size={20}/>}</button>
                                        <button onClick={toggleFs} className="text-slate-400 p-2 rounded-full hover:bg-slate-100 md:hidden">{isFullscreen?<Minimize size={20}/>:<Maximize size={20}/>}</button>
                                    </div>
                                </div>
                                <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-1">
                                    {[{id:'dashboard',l:'儀表板'},{id:'input',l:'記帳'},{id:'records',l:'歷史'},{id:'settings',l:'設定'}].map(t=><button key={t.id} onClick={()=>setActiveTab(t.id)} className={`px-4 py-1.5 rounded-full whitespace-nowrap text-sm font-medium transition ${activeTab===t.id?'bg-slate-800 text-white shadow':'text-slate-500 hover:bg-slate-100'}`}>{t.l}</button>)}
                                </div>
                            </header>

                            {/* Main Content */}
                            <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-safe-bottom">
                                {activeTab === 'dashboard' && (
                                    <div className="space-y-4 animate-fade-in pb-20">
                                        {showBackupAlert && <div className="bg-amber-50 border border-amber-200 p-3 rounded-lg flex justify-between items-center text-sm text-amber-800"><span className="flex items-center gap-2"><AlertTriangle size={16}/> 建議備份</span><Button onClick={exportJSON} size="sm" variant="warning">備份</Button></div>}
                                        <div className="grid grid-cols-2 gap-4">
                                            <Card className="p-4 border-l-4 border-blue-500"><div className="text-xs text-slate-500">總獲利 (金額)</div><div className="text-xl font-bold text-slate-800">{fmtCur(totalStats.pl)}</div></Card>
                                            <Card className={`p-4 border-l-4 ${portfolioXIRR>=0?'border-red-500':'border-green-500'}`}><div className="text-xs text-slate-500">年化報酬 (XIRR)</div><div className={`text-xl font-bold ${portfolioXIRR>=0?'text-red-600':'text-green-600'}`}>{(portfolioXIRR*100).toFixed(2)}%</div></Card>
                                        </div>
                                        
                                        <Card className="p-4 h-80 flex flex-col">
                                            <div className="flex justify-between items-center mb-4">
                                                <div className="flex bg-slate-100 rounded p-1">
                                                    <button onClick={()=>setDashboardMode('assets')} className={`px-3 py-1 text-xs rounded font-medium transition-all ${dashboardMode==='assets'?'bg-white shadow text-blue-600':'text-slate-500'}`}>資產走勢</button>
                                                    <button onClick={()=>setDashboardMode('performance')} className={`px-3 py-1 text-xs rounded font-medium transition-all ${dashboardMode==='performance'?'bg-white shadow text-red-600':'text-slate-500'}`}>獲利 PK</button>
                                                </div>
                                                <div className="flex gap-1 overflow-x-auto scrollbar-hide">{['1M','1Y','3Y','ALL'].map(r=><button key={r} onClick={()=>setTimeRange(r)} className={`px-2 py-1 text-xs rounded border ${timeRange===r?'bg-slate-800 text-white border-slate-800':'border-slate-200 text-slate-500'}`}>{r}</button>)}</div>
                                            </div>
                                            
                                            <div className="flex-1 w-full relative">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    {dashboardMode === 'assets' ? (
                                                        <ComposedChart data={filteredData}>
                                                            <defs><linearGradient id="cV" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.1}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient></defs>
                                                            <XAxis dataKey="date" hide={false} tick={{fontSize: 10}} tickFormatter={fmtDateAxis} minTickGap={30} />
                                                            {/* 智慧刻度 */}
                                                            <YAxis yAxisId="left" orientation="left" hide={false} width={40} tick={{fontSize: 9}} tickFormatter={fmtAxis} domain={['auto', 'auto']} />
                                                            <YAxis yAxisId="right" orientation="right" hide={false} width={40} tick={{fontSize: 9, fill: '#f97316'}} domain={['auto', 'auto']} />
                                                            <Tooltip formatter={(v, n)=> n.includes('指數') ? v : fmtCur(v)} labelStyle={{color:'#333'}} />
                                                            <Legend wrapperStyle={{fontSize:'10px', paddingTop:'5px'}}/>
                                                            <Area yAxisId="left" type="monotone" dataKey="total" name="總市值 (左)" stroke="#3b82f6" fill="url(#cV)" strokeWidth={2}/>
                                                            <Line yAxisId="right" type="monotone" dataKey="benchmarkVal" name="台股指數 (右)" stroke="#f97316" strokeDasharray="3 3" dot={false} strokeWidth={2} connectNulls={true} />
                                                        </ComposedChart>
                                                    ) : (
                                                        <LineChart data={filteredData}>
                                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0"/>
                                                            <XAxis dataKey="date" hide={false} tick={{fontSize: 10}} tickFormatter={fmtDateAxis} minTickGap={30} />
                                                            <YAxis hide={false} width={40} tick={{fontSize: 9}} tickFormatter={fmtAxis} domain={['auto', 'auto']} />
                                                            <Tooltip formatter={(v)=>fmtCur(v)} labelStyle={{color:'#333'}} />
                                                            <Legend wrapperStyle={{fontSize:'10px', paddingTop:'5px'}}/>
                                                            <ReferenceLine y={0} stroke="#94a3b8" />
                                                            <Line type="monotone" dataKey="userProfit" name="我的獲利 ($)" stroke="#ef4444" strokeWidth={2} dot={false} connectNulls={true} />
                                                            <Line type="monotone" dataKey="benchProfit" name="大盤模擬獲利 ($)" stroke="#64748b" strokeWidth={2} dot={false} strokeDasharray="5 5" connectNulls={true} />
                                                        </LineChart>
                                                    )}
                                                </ResponsiveContainer>
                                            </div>
                                            
                                            {dashboardMode === 'performance' && (
                                                <div className="flex justify-between text-xs mt-3 pt-3 border-t border-slate-100">
                                                    <div className="text-center flex-1 border-r">
                                                        <div className="text-slate-400">總獲利 (Abs)</div>
                                                        <div className={`font-bold ${totalStats.pl>=0?'text-red-500':'text-green-500'}`}>{fmtCur(totalStats.pl)}</div>
                                                    </div>
                                                    <div className="text-center flex-1">
                                                        <div className="text-slate-400">大盤模擬獲利</div>
                                                        <div className="font-bold text-slate-700">{chartData.length>0 ? fmtCur(chartData[chartData.length-1].benchProfit || 0) : 0}</div>
                                                    </div>
                                                </div>
                                            )}
                                        </Card>

                                        <Card className="p-4">
                                            <div className="font-bold text-slate-700 mb-4 flex items-center gap-2"><PieIcon size={16}/> 配置</div>
                                            <div className="h-40"><ResponsiveContainer><PieChart><Pie data={pieData} innerRadius={35} outerRadius={60} dataKey="value"><Tooltip formatter={v=>fmtCur(v)}/>{pieData.map((e,i)=><Cell key={i} fill={e.color}/>)}</Pie></PieChart></ResponsiveContainer></div>
                                            <div className="space-y-2 text-sm">{pieData.map(d=><div key={d.name} className="flex justify-between"><div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full" style={{backgroundColor:d.color}}></span>{d.name}</div><span>{((d.value/totalStats.value)*100).toFixed(1)}%</span></div>)}</div>
                                        </Card>
                                    </div>
                                )}

                                {activeTab === 'input' && (
                                    <Card className="p-5 space-y-5 animate-fade-in pb-20">
                                        <div className="flex justify-between items-center"><h2 className="font-bold text-slate-800">新增紀錄</h2><Button variant="magic" size="sm" onClick={()=>setModalType('ai')}><Sparkles size={16}/> AI 貼上</Button></div>
                                        
                                        <div className="bg-slate-100 p-1 rounded-lg flex mb-4">
                                            <button onClick={()=>setInputType('balance')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${inputType==='balance'?'bg-white text-slate-800 shadow-sm':'text-slate-500'}`}>
                                                <div className="flex items-center justify-center gap-2"><Briefcase size={16}/> 市值更新</div>
                                            </button>
                                            <button onClick={()=>setInputType('flow')} className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${inputType==='flow'?'bg-white text-blue-600 shadow-sm':'text-slate-500'}`}>
                                                <div className="flex items-center justify-center gap-2"><CreditCard size={16}/> 資金存提</div>
                                            </button>
                                        </div>

                                        <div className="space-y-4">
                                            <div className="grid grid-cols-2 gap-3">
                                                <Input type="date" label="日期" value={entryDate} onChange={e=>setEntryDate(e.target.value)} />
                                                <Select label="帳戶" value={selectedAccount} onChange={e=>setSelectedAccount(e.target.value)} options={accounts.map(a=>({value:a.id,label:a.name}))} />
                                            </div>
                                            
                                            {inputType === 'balance' ? (
                                                <div className="animate-fade-in">
                                                    <Input label="當前總市值" type="number" value={marketValue} onChange={e=>setMarketValue(e.target.value)} placeholder="輸入總市值" />
                                                </div>
                                            ) : (
                                                <div className="space-y-4 animate-fade-in">
                                                    <div>
                                                        <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 block">資金流向</label>
                                                        <div className="flex gap-2">
                                                            <button onClick={()=>setFlowType('deposit')} className={`flex-1 py-3 rounded-lg border text-sm font-medium transition-all ${flowType==='deposit'?'bg-blue-50 border-blue-200 text-blue-600 ring-2 ring-blue-100':'bg-white border-slate-200 text-slate-600'}`}>存入 (Deposit)</button>
                                                            <button onClick={()=>setFlowType('withdraw')} className={`flex-1 py-3 rounded-lg border text-sm font-medium transition-all ${flowType==='withdraw'?'bg-orange-50 border-orange-200 text-orange-600 ring-2 ring-orange-100':'bg-white border-slate-200 text-slate-600'}`}>領出 (Withdraw)</button>
                                                        </div>
                                                    </div>
                                                    <Input label="金額" type="number" value={inputFlow} onChange={e=>setInputFlow(e.target.value)} placeholder="輸入金額" />
                                                </div>
                                            )}

                                            <div className="pt-4 border-t border-slate-100 flex justify-between items-center">
                                                 <div className="flex-1 mr-2">
                                                     <Input label="大盤指數 (自動)" type="number" value={benchmarkInput} onChange={e=>setBenchmarkInput(e.target.value)} placeholder={getTaiexEstimate(entryDate) || "輸入指數"} />
                                                 </div>
                                                 <Button onClick={()=>fetchBenchmarkData(true)} variant="outline" size="sm" className="mt-6 h-11" disabled={isFetchingBenchmark}>
                                                    {isFetchingBenchmark ? <Loader2 className="animate-spin" size={16}/> : <RefreshCw size={16}/>}
                                                 </Button>
                                            </div>
                                        </div>

                                        <Button onClick={handleAdd} className="w-full mt-4 text-lg py-4 shadow-md shadow-blue-200"><Save size={20}/> 儲存紀錄</Button>
                                    </Card>
                                )}

                                {activeTab === 'records' && (
                                    <div className="space-y-3 animate-fade-in pb-20">
                                        {sortedRecs.slice().reverse().map(r=>(
                                            <div key={r.id} className="bg-white p-3 rounded-lg border border-slate-100 flex justify-between items-center shadow-sm">
                                                <div>
                                                    <div className="text-sm font-bold text-slate-700 flex items-center gap-2">{r.date} <span className="text-[10px] font-normal text-slate-400 border px-1 rounded">{accounts.find(a=>a.id===r.accountId)?.name}</span></div>
                                                    <div className="text-xs text-slate-400 mt-1 flex gap-2">
                                                        {r.cashFlow!==0 && <span className={r.cashFlow>0?'text-blue-500 font-medium':'text-orange-500 font-medium'}>{r.cashFlow>0?'存入':'領出'} {Math.abs(r.cashFlow)}</span>}
                                                        {r.benchmarkValue && <span className="text-slate-300">| 指數 {r.benchmarkValue}</span>}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-3">
                                                    <div className="font-mono font-medium text-slate-800">{fmtCur(r.marketValue)}</div>
                                                    <button onClick={()=>setRecords(p=>p.filter(x=>x.id!==r.id))} className="text-slate-300 hover:text-red-500 p-2"><Trash2 size={18}/></button>
                                                </div>
                                            </div>
                                        ))}
                                        {records.length===0 && <div className="text-center text-slate-400 py-10">尚無紀錄</div>}
                                    </div>
                                )}

                                {activeTab === 'settings' && (
                                    <div className="space-y-4 animate-fade-in pb-20">
                                        <Card className="p-4 flex justify-between items-center"><div className="flex gap-3 items-center"><Smartphone className="text-blue-600"/><div><div className="font-bold">App 模式</div><div className="text-xs text-slate-500">安裝到主畫面</div></div></div><Button size="sm" variant="outline" onClick={()=>setModalType('install')}>查看</Button></Card>
                                        
                                        <Card className="p-4 space-y-3">
                                            <h3 className="font-bold flex gap-2 items-center text-slate-700"><Database size={18}/> 資料管理</h3>
                                            <div className="flex gap-2">
                                                <Button onClick={exportJSON} variant="outline" className="flex-1 text-sm"><Download size={16}/> 備份 JSON</Button>
                                                <div className="flex-1 relative">
                                                    <input type="file" accept=".json" onChange={e=>{if(e.target.files?.length){setImportFile(e.target.files[0]);setModalType('import');e.target.value='';}}} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"/>
                                                    <Button variant="outline" className="w-full text-sm"><Upload size={16}/> 還原 JSON</Button>
                                                </div>
                                            </div>
                                            <div className="pt-2 border-t border-slate-100 flex justify-end">
                                                <Button onClick={()=>setModalType('clear')} variant="danger" size="sm" className="px-3 text-xs">清空全部資料</Button>
                                            </div>
                                        </Card>

                                        <Card className="p-4">
                                            <h3 className="font-bold mb-2 text-slate-700">AI 設定 (Gemini API)</h3>
                                            <div className="flex gap-2">
                                                <Input type="password" value={settings.apiKey} onChange={e=>setSettings({...settings,apiKey:e.target.value})} placeholder="貼上 API Key (若已輸入過可留空)" />
                                            </div>
                                            <p className="text-[10px] text-slate-400 mt-1">Key 僅儲存於本地瀏覽器，不會上傳伺服器。</p>
                                        </Card>

                                        <Card className="p-4 space-y-2">
                                            <h3 className="font-bold text-slate-700 mb-2">帳戶管理</h3>
                                            {accounts.map(a=>(
                                                <div key={a.id} className="flex gap-2 items-center">
                                                    <input type="color" value={a.color} onChange={e=>{const n=[...accounts];n.find(x=>x.id===a.id).color=e.target.value;setAccounts(n)}} className="w-8 h-8 rounded border-none cursor-pointer flex-shrink-0"/>
                                                    <Input value={a.name} onChange={e=>{const n=[...accounts];n.find(x=>x.id===a.id).name=e.target.value;setAccounts(n)}} />
                                                    <button onClick={()=>{if(accounts.length>1){if(confirm('確定刪除此帳號與相關紀錄?')){setAccounts(accounts.filter(x=>x.id!==a.id));setRecords(records.filter(r=>r.accountId!==a.id))}}}} className="text-slate-300 hover:text-red-500 p-2"><Trash2 size={18}/></button>
                                                </div>
                                            ))}
                                            <Button onClick={()=>{setAccounts([...accounts, {id:Date.now().toString(), name:'新帳號', color:'#64748b'}])}} variant="secondary" className="w-full mt-2 text-sm">新增帳號</Button>
                                        </Card>
                                        
                                        <div className="text-center text-xs text-slate-300 pt-4">App Version: {APP_VERSION}</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    );
                };

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            } catch (err) {
                document.getElementById('loader').innerHTML = '<div class="p-4 text-center text-red-500"><p class="font-bold">系統錯誤</p><p class="text-sm">'+err.message+'</p></div>';
                console.error(err);
            }
        })();
    </script>
</body>
</html>
